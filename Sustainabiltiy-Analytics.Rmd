---
title: "Evaluation of Variable Renewable Energy Source's 
Contribution to Cost of Control Energy"
author: "Fabian Del Conte, Pascal Küng, Jan van Lengerich, Alec Vayloyan"
date: "2024-09-30"
output:
  pdf_document:
    toc: yes
    toc_depth: 2
    number_sections: true
bibliography: references.bib
editor_options: 
  chunk_output_type: console
notes: footnotes
---

```{r, load libraries, include = F, warning = F}
library(knitr)
library(readxl) #install packages first if not done so already
library(readr)
library(tidyr)
library(tidyquant)
library(lubridate)
library(ggplot2)
library(forecast)
library(tseries)
library(rugarch)
library(vars)
library(scales)
library(dplyr)
library(readr)
library(stringr)

setwd(dirname(rstudioapi::getSourceEditorContext()$path)) #setting directory
```

```{r, importing power prices, warning = F, include= F, cache= T}
sheets_after_2015 <- c("EnergieUebersichtCH-2015.xls",
                       "EnergieUebersichtCH-2016.xls", 
                       "EnergieUebersichtCH-2017.xls",
                       "EnergieUebersichtCH-2018.xls", 
                       "EnergieUebersichtCH-2019.xls",
                       "EnergieUebersichtCH-2020.xls"
                       )

sheets_after_2021 <- c("EnergieUebersichtCH-2021.xlsx",
                       "EnergieUebersichtCH-2022.xlsx",
                       "EnergieUebersichtCH-2023.xlsx",
                       "EnergieUebersichtCH-2024.xlsx"
                       )

# Empty list to store data frames
data_list <- list()

# Loop through the sheets and read each one for xls
for (s in sheets_after_2015) {
  # Read the Excel file
  df <- read_xls(s, sheet = "Zeitreihen0h15",)
  df <- df %>% select(1, 7,8,9,10, 22:25) 
  
  # Convert the timestamp column
  df[[1]] <- as.numeric(df[[1]])
  df$Timestamp <- as.POSIXct(df[[1]] * 86400,
                             origin = "1899-12-29 23:00:00",
                             tz = "Europe/Zurich")
  
  # Store the data frame in the list
  data_list[[s]] <- df %>% select(-1)
}

# Loop through the sheets and read each one for xlsx
for (s in sheets_after_2021) {
  # Read the Excel file
  df <- read_xlsx(s, sheet = "Zeitreihen0h15",)
  df <- df %>% select (1, 7,8,9,10, 22:25) 
  
  # Convert the timestamp column
  df$Timestamp <- as.POSIXct(df[[1]],
                             format = "%d.%m.%Y %H:%M",
                             tz = "Europe/Zurich")
  
  #remove first column
  df <- df %>% select(-1)
  
  # Set the column-names to match the xls data
  # Adjusting the slightly different spelling
  colnames(df) <- 
    colnames(data_list[["EnergieUebersichtCH-2015.xls"]])
  
  # Store the data frame in the list
  data_list[[s]] <- df
}

# Combine all data frames in the list into one
combined_data <- bind_rows(data_list)

combined_data <- combined_data %>% 
  filter(combined_data[[2]] != "kWh") # taking out the duplicated headers which
                                      # ended up in the dataframe
```

```{r, manipulations 1, warning = F, include= F, cache= T}
combined_data <- combined_data %>% 
  rename(
    pos_sec_amount_kwh = names(combined_data)[1], 
    neg_sec_amount_kwh = names(combined_data)[2],
    pos_ter_amount_kwh = names(combined_data)[3],
    neg_ter_amount_kwh = names(combined_data)[4],
    price_pos_sec_EUR_MWh = names(combined_data)[5],
    price_neg_sec_EUR_MWh = names(combined_data)[6],
    price_pos_ter_EUR_MWh = names(combined_data)[7],
    price_neg_ter_EUR_MWh = names(combined_data)[8]
    ) 

combined_data <- combined_data %>% 
    mutate(across(c(1:8), as.numeric)) # convert to numeric

combined_data <- combined_data %>% 
  mutate( #calculating costs of energy
  cost_pos_sec = (combined_data[[1]] / 1000)*combined_data[[5]], 
  cost_neg_sec = (combined_data[[2]] / 1000)*combined_data[[6]],  
  cost_pos_ter = (combined_data[[3]] / 1000)*combined_data[[7]],
  cost_neg_ter = (combined_data[[4]] / 1000)*combined_data[[8]]
  ) %>% 
  select(9, everything())  #rearranging
```


```{r, manipulations 2, warning = F, include= F, cache= T}
hourly_summary <- combined_data %>%
  # create a column 'hour' by rounding down to the nearest hour
  mutate(hour = floor_date(Timestamp, "hour")) %>%  
  group_by(hour) %>%  # Group by the new 'hour' column
  summarise(
    # Sum the energy amount columns
    pos_sec_amount_kwh = sum(pos_sec_amount_kwh, na.rm = TRUE),
    neg_sec_amount_kwh = sum(neg_sec_amount_kwh, na.rm = TRUE),
    pos_ter_amount_kwh = sum(pos_ter_amount_kwh, na.rm = TRUE),
    neg_ter_amount_kwh = sum(neg_ter_amount_kwh, na.rm = TRUE),

    # Sum the cost columns
    cost_pos_sec = sum(cost_pos_sec, na.rm = TRUE),
    cost_neg_sec = sum(cost_neg_sec, na.rm = TRUE),
    cost_pos_ter = sum(cost_pos_ter, na.rm = TRUE),
    cost_neg_ter = sum(cost_neg_ter, na.rm = TRUE),

    # Average the price columns
    avg_price_pos_sec_EUR_MWh = mean(price_pos_sec_EUR_MWh, na.rm = TRUE),
    avg_price_neg_sec_EUR_MWh = mean(price_neg_sec_EUR_MWh, na.rm = TRUE),
    avg_price_pos_ter_EUR_MWh = mean(price_pos_ter_EUR_MWh, na.rm = TRUE),
    avg_price_neg_ter_EUR_MWh = mean(price_neg_ter_EUR_MWh, na.rm = TRUE)
  ) %>%
  ungroup() %>%   # Ungroup to complete the operation
  rename(
  Timestamp    = hour #renaming for merging
  )
```


```{r, importing renwable share and grid load, include = F , warning = F, include= F}
# Importing the generation data per production type
gen_per_type_list <- c("Actual Generation per Production Type_201501010000-201601010000.csv",
                       "Actual Generation per Production Type_201601010000-201701010000.csv",
                       "Actual Generation per Production Type_201701010000-201801010000.csv",
                       "Actual Generation per Production Type_201801010000-201901010000.csv",
                       "Actual Generation per Production Type_201901010000-202001010000.csv",
                       "Actual Generation per Production Type_202001010000-202101010000.CSV",
                       "Actual Generation per Production Type_202101010000-202201010000.csv",
                       "Actual Generation per Production Type_202201010000-202301010000.csv",
                       "Actual Generation per Production Type_202301010000-202401010000.csv",
                       "Actual Generation per Production Type_202401010000-202501010000.csv")

# Initialize an empty dataframe to store the combined data
df_combined_type <- tibble()

# Loop through the different csv
for (s in gen_per_type_list) {
  # Read the csv
  df_gen_per_type <- read_csv(s, na = c("N/A", "", "n/e", "-"))
  
  # Combine the dataframes
  df_combined_type <- bind_rows(df_combined_type, df_gen_per_type)
  }

# Importing the grid load data
grid_load_list <- c("Total Load - Day Ahead _ Actual_201501010000-201601010000.csv",
                    "Total Load - Day Ahead _ Actual_201601010000-201701010000.csv",
                    "Total Load - Day Ahead _ Actual_201701010000-201801010000.csv",
                    "Total Load - Day Ahead _ Actual_201801010000-201901010000.csv",
                    "Total Load - Day Ahead _ Actual_201901010000-202001010000.csv",
                    "Total Load - Day Ahead _ Actual_202001010000-202101010000.csv",
                    "Total Load - Day Ahead _ Actual_202101010000-202201010000.csv",
                    "Total Load - Day Ahead _ Actual_202201010000-202301010000.csv",
                    "Total Load - Day Ahead _ Actual_202301010000-202401010000.csv",
                    "Total Load - Day Ahead _ Actual_202401010000-202501010000.csv")

# Initialize an empty dataframe to store the combined data
df_combined_load <- tibble()

# Loop through the different csv
for (s in grid_load_list) {
  # Read the csv
  df_load <- read_csv(s, na = c("N/A", "", "n/e", "-"))
  
  # Combine the dataframes
  df_combined_load <- bind_rows(df_combined_load, df_load)
  }


# Create timestamps for the dataframe (per type)
df_combined_type <- df_combined_type %>%
  mutate(
    # Extract the starting date-time part of the MTU column
    StartTimestamp = sapply(str_split(MTU, " - "), `[`, 1),
    Timestamp = suppressWarnings(
      dmy_hm(StartTimestamp, tz = "Europe/Zurich"))
    ) %>%
  select(-StartTimestamp) %>% 
  # Remove rows where Timestamp is NA (problem with daylight savings time)
  filter(!is.na(Timestamp)) %>% 
  # Remove duplicate rows (there are duplicate rows because of daylight savings 
  # time (time from 02:00 to 03:00 happens twice) -> only keep the first row)
  distinct(Timestamp, .keep_all = TRUE)


# Create timestamps for the dataframe (load)
df_combined_load <- df_combined_load %>%
  mutate(
    # Extract the starting date-time part of the MTU column
    StartTimestamp = sapply(str_split(`Time (CET/CEST)`, " - "), `[`, 1),
    Timestamp = suppressWarnings(
      dmy_hm(StartTimestamp, tz = "Europe/Zurich"))
    ) %>%
  select(-StartTimestamp) %>% 
  # Remove rows where Timestamp is NA (problem with daylight savings time)
  filter(!is.na(Timestamp)) %>% 
  # Remove duplicate rows (there are duplicate rows because of daylight savings 
  # time (time from 02:00 to 03:00 happens twice) -> only keep the first row)
  distinct(Timestamp, .keep_all = TRUE)


# Merging two combined dataframes on the timestamp
df_gen_load_raw <- full_join(df_combined_type, df_combined_load,
               by = "Timestamp") 


# Clean up combined df
df_gen_load <- df_gen_load_raw %>% 
  # Remove columns where all values are NAs (Fossil - brown coal for example)
  select(where(~ any(!is.na(.)))) %>% 
  # Remove column are (CH)
  # Remove columns conatining original time information and area
  select(-c("Area", "MTU", "Time (CET/CEST)"))

# Adding VRES (percentage Swiss (solar + wind) production / load on grid)
df_gen_load <- df_gen_load %>%
  mutate(VRES_percent = (`Solar  - Actual Aggregated [MW]` + `Wind Onshore  - Actual Aggregated [MW]`) / `Actual Total Load [MW] - BZN|CH`)
```


```{r, join, include= F, warning = F }
df_combined <- left_join(hourly_summary, df_gen_load, by = "Timestamp") 
# merging on the hour
```


```{r, adding total cost, include = F, warning = F}
# Add total cost
df_combined <- df_combined %>% 
  #calculating total cost by summing all costs
  mutate(total_cost_EUR = 
           cost_pos_sec+cost_neg_sec+cost_pos_ter+cost_neg_ter)

# Save the lines with NA values in VRES or Total cost -> 57 lines / hours
df_na_output <- df_combined %>% 
  filter(is.na(VRES_percent) | is.na(total_cost_EUR))

# Exclude the lines with NA values in VRES or Total cost
df_combined <- df_combined %>% 
  filter(!is.na(VRES_percent) & !is.na(total_cost_EUR)) 

# Rearrange and rename rows in df_combined
d.h <- df_combined %>% 
  select(Timestamp, VRES_percent, total_cost_EUR,
         total_load_MW = `Actual Total Load [MW] - BZN|CH`,
         cost_pos_sec_EUR = cost_pos_sec, cost_neg_sec_EUR = cost_neg_sec,
         cost_pos_ter_EUR = cost_pos_ter, cost_neg_ter_EUR = cost_neg_ter,
         pos_sec_amount_kwh, neg_sec_amount_kwh,
         pos_ter_amount_kwh, neg_ter_amount_kwh,
         avg_price_pos_sec_EUR_MWh, avg_price_neg_sec_EUR_MWh,
         avg_price_pos_ter_EUR_MWh, avg_price_neg_ter_EUR_MWh,
         CH_solar_generation_actual_MW = `Solar  - Actual Aggregated [MW]`,
         CH_wind_onshore_generation_actual_MW =
           `Wind Onshore  - Actual Aggregated [MW]`,
         everything())

# removing clutter
remove(combined_data, data_list, df, df_load, df_combined,
       df_combined_load, df_combined_type, 
       df_gen_load, df_gen_per_type, hourly_summary)
```


```{r, Test cost of 2020, warning = F, include= F}
sums_2020 <- d.h %>%
    filter(year(Timestamp) == 2020) %>%
    summarise(across(where(is.numeric), ~ sum(.x, na.rm = FALSE)))
# Comparison with report shows same numbers
```


```{r, daily-data_load, include = F, warning = F}
# Load the datasets
energy_production <- read_csv("ogd104_stromproduktion_swissgrid.csv")
energy_prices <- read_csv("ogd106_preise_strom_boerse.csv")

# Reshape the energy production data to have one column per energy source
energy_production <- energy_production %>%
  pivot_wider(names_from = Energietraeger, values_from = Produktion_GWh, values_fill = 0)

# Merge the reshaped energy production data with the energy prices data
d.d <- merge(energy_prices, energy_production, by="Datum", all.x=TRUE)

# Fill any remaining NAs with 0 (in case there were dates in energy_prices not in energy_production)
d.d[is.na(d.d)] <- 0
```

```{r, daily-data_rename variables, include = F, warning = F}

# Rename columns in dataset
d.d <- d.d %>%
  rename(
    Date = Datum,
    Hydro_GWh = Flusskraft,
    Nuclear_GWh = Kernkraft,
    Storage_GWh = Speicherkraft,
    Thermal_GWh = Thermische,
    Photovoltaic_GWh = Photovoltaik,
    Wind_GWh = Wind
  )
```

```{r, daily_data-add vres and non-vres, include = F, warning = F}

# Add new columns 'VRES_GWh' and 'Non_VRES_GWh' to d.d
d.d <- d.d %>%
  mutate(
    VRES_GWh = Photovoltaic_GWh + Wind_GWh,
    Non_VRES_GWh = Hydro_GWh + Nuclear_GWh + Storage_GWh + Thermal_GWh
  )

# View the first few rows to confirm the new columns
head(d.d)

# remove not needed data
remove(energy_production, energy_prices)
```

\newpage
# Introduction
Governments and scientists around the world largely agree on the need for a low-carbon electricity production. A step in this direction is the construction, installation and connection of Renewable Energy Sources (RES) such as hydropower, wind and solar to the electricity grid. These produce little to no direct emissions while supplying electricity and have life cycle carbon costs far lower than fossil fuel[^LCE-Electricity]. A substrate of RES are so called Variable-RES (VRES), which are electricity sources, whose production cannot easily be increased or decreased by the power plant operator. Wind and solar both rely on meteorological conditions and if these are not right, nothing is produced. This is contrary to most other energy sources whose production can be increased or decreased according to market needs. Although the time it takes to ramp production up or down can still present a challenge. 

The lack of direct control over production with VRES presents a challenge to the adoption of such sources, since they lead to an increased need for short and long term energy storage. Battery Storage, Pumped Hydro and Heat Pumps do store energy, but the current capacity needs to be further increased to adapt to the increased percentage of power production from VRES sources.[^energystorage1]

[^LCE-Electricity]: https://www.nrel.gov/docs/fy21osti/80580.pdf
[^energystorage1]: https://energy.ec.europa.eu/topics/research-and-technology/energy-storage/recommendations-energy-storage_en

The addition of electricity from VRES has effect of:

1. Lowering electricity prices.[^VRES-L1]
2. Increasing price volatility.
3. Rapidly changing the quantity of electricity available on the grid in either direction.[^VRES-L2]

[^VRES-L1]: https://www.irena.org/news/pressreleases/2022/Jul/Renewable-Power-Remains-Cost-Competitive-amid-Fossil-Fuel-Crisis
[^VRES-L2]:https://www.next-kraftwerke.de/energie-blog/preisschwankungen-regelenergie

The reason for the first claim is that VRES has practically no marginal costs. No fuel rods, pumping, gas or other notable inputs are required to produce solar and wind energy. This means producers of VRES will bid their energy at almost any price.

The second claim is the case because meteorological events tend to be fairly consistent across an area. When one wind / solar farm is producing, so are the ones around it. This means there is huge downward pressure on prices during periods of favorable VRES production and none at all during unfavorable conditions.

The third claim is particularly relevant for the grid operator, which is responsible for maintaining a stable electricity grid. With the increase of VRES production it can be assumed that the demand for control energy will increase. This increase in demand would lead to higher costs for the TSO and hence for the end consumers.

\newpage
# Context and Framework
## Control Energy
The Transmission System Operator (TSO) has the responsibility to maintain the stability of the electrical grid. A TSO doesn't produce energy itself, but buys control energy from energy producers or some large consumers. This control energy is used in the event of an imbalance between energy production and consumption on the grid.[^Swissgrid1]
The control energy is split up in primary, secondary and tertiary control energy. They differ in activation time (30 seconds, 5 minutes and 15 minutes). Furthermore Control Energy is separated between positive and negative control energy. 

Positive control energy corresponds to an increase in generation or reducing consumption, while negative control energy involves decreasing generation or increasing consumption.[^Swissgrid2] The positive secondary control energy is tendered separately from the negative secondary control energy, which is also the case with the tertiary positive / negative control energy. The grid provider pays for the capacity provision (availability of resources that can be mobilized in the required time frame) and for the control energy activated and the costs are passed on to the end consumers.[^elcom2021]

In Figure \ref{fig:Viz} the event of an energy imbalance on the power grid with the corresponding activation of the control energy is illustrated. It shows the case of the consumption exceeding the production. This could occur for example in the event of an unplanned failure of a power plant. To maintain grid stability (keep the frequency at the desired 50\ Hz) first the primary positive control energy is activated, which will get replaced by the secondary control energy, which will get replaced by the tertiary control energy.

\begin{figure}[h]
  \centering
  \includegraphics[width=130mm]{Control-energy-im1.png}
  \caption{Visualization of energy imbalance and control energy activation, adapted from \href{https://www.swissgrid.ch/dam/swissgrid/about-us/newsroom/dossiers/control-energy-market-en.pdf}{Swissgrid}.}
  \label{fig:Viz}
  \centering
\end{figure}

[^Swissgrid1]: https://www.swissgrid.ch/en/home/about-us/company/what-we-do.html
[^Swissgrid2]: https://www.swissgrid.ch/en/home/operation/regulation/grid-stability.html
[^elcom2021]: https://www.elcom.admin.ch/dam/elcom/de/dokumente/2022/berichtregelleistungundregelenergie2021.pdf

\newpage
## Systemic View
The electricity production and the maintaining of a stable electricity grid with the various influencing factors, such as the rise of renewable energy sources, is a very complex systemic problem. During the work on this project a lot of thinking went into the variety of influencing factors and interactions withing the system. One product of this process was a simplified dynamic system created using the Tool "Loopy" [^Loopy] (\href{https://tinyurl.com/3yu9ft9n}{Link to created system}).

[^Loopy]: https://ncase.me/loopy/v1.1/?data=%5B%5B%5B5,602,427,0.83,%22Grid%2520infastructure%22,1%5D,%5B6,802,337,0.5,%22Resilience%22,3%5D,%5B7,409,503,0.5,%22Production%2520Renewables%22,4%5D,%5B8,386,295,0.5,%22Volatility%22,2%5D,%5B9,786,590,0.5,%22Regulation%22,1%5D,%5B10,551,683,0.5,%22market%2520mechanics%22,5%5D,%5B12,571,250,0.66,%22Climate%2520Change%22,0%5D,%5B13,1047,474,0.5,%22Exogenous%2520Factors%22,0%5D%5D,%5B%5B5,6,-40,1,0%5D,%5B7,8,35,1,0%5D,%5B8,5,57,-1,0%5D,%5B9,6,4,1,0%5D,%5B9,5,5,1,0%5D,%5B10,6,-239,1,0%5D,%5B6,10,239,-1,0%5D,%5B9,10,-20,-1,0%5D,%5B8,6,-30,-1,0%5D,%5B8,10,-172,1,0%5D,%5B10,5,21,1,0%5D,%5B10,8,172,-1,0%5D,%5B10,9,-61,1,0%5D,%5B12,9,26,1,0%5D,%5B9,7,-11,1,0%5D,%5B7,12,10,-1,0%5D,%5B12,6,49,-1,0%5D,%5B12,8,-186,1,0%5D,%5B7,5,22,-1,0%5D,%5B5,7,18,-1,0%5D,%5B13,12,-161,1,0%5D,%5B13,10,194,1,0%5D,%5B13,10,192,-1,0%5D,%5B13,12,-161,1,0%5D,%5B13,12,-161,1,0%5D%5D,%5B%5D,13%5D

### Relevant Sustainable Development Goals
The relevant Sustainable Developlment Goals[^sdg] (SDGs) are shown in Figure \ref{fig:SDG-context}. The most relevant Sustainable Development Goal for the context of this report is SDG\ 7 (affordable and clean energy).

\begin{figure}[hb]
  \centering
  \includegraphics[width=130mm]{SDG-context.png}
  \caption{Affected Sustainable Development Goals, adapted from \href{https://sdgs.un.org/goals}.}
  \label{fig:SDG-context}
  \centering
\end{figure}

As described in the introduction, the expansion of renewable energy sources can achieve both aspects of this goal by reducing the carbon footprint and lowering electricity prices. This effect is also beneficial to achieve SDG 12 and 13. The expected larger cost to stabilize the grid infrastructure leads to additional costs for the end consumers. Reducing the costs to maintain the stability of the grid, taking into account those circumstances, would be beneficial for everyone and help achieve more affordable energy.

A stable grid infrastructure is important for the economy and many aspects of people's personal life (SDG 8 and 9). The production of clean energy also has an effect on SDG 14 and 15. The building and maintaining of new power plants can endanger the habitat of various animals. If additional structures or power plants are needed to stabilize the grid, this could also pose risks concerning these goals.

On the other hand, the development and construction of new renewable energy infrastructure present significant opportunities for job creation and innovation. This aligns with SDG 8, which aims to promote sustained and sustainable economic growth. The need for advanced technologies and innovative solutions to integrate renewable energy sources into the grid can drive research and development.

In conclusion, while the expansion of renewable energy sources comes with certain challenges, the potential benefits in terms of reducing carbon footprints, lowering electricity prices, creating jobs, and fostering innovation make it a crucial endeavor for achieving multiple SDGs.

It is therefore important for stakeholder to understand the drivers of increased prices of control energy. This is particularly important in the context of the SDG 7, which stresses the need for clean energy. Policymakers must understand the impact of increasing the share of VRES on the grid to be aware of potential economic and political backlash of their decisions.

[^sdg]: <https://sdgs.un.org/goals>

### Stakeholders
In the context of grid stability and control energy, several key stakeholders play crucial roles. Swissgrid, as the TSO in Switzerland, is responsible for managing and maintaining the stability of the electrical grid. They are responsible for ensuring that electricity supply meets demand in real-time, which is essential for preventing blackouts and maintaining a reliable energy supply. 

Policymakers are also vital stakeholders, as they create the regulatory framework and incentives that drive the adoption of renewable energy and the necessary investments in grid infrastructure.

Consumers, too, are important stakeholders. In the end, they pay the price for electricity, which includes a portion for the cost of the infrastructure. Additionally, they can play a role in improving grid stability through the adoption of new smart home technologies and local energy storage solutions.

## Literature Review

The academic literature on VRES's effect on control energy is fairly sparse. Using the search terms "control energy" and "(variable) renewable energy", only one relevant paper was found. @hirth_control_2013 have found that the inclusion of VRES from 2008-2013 decreased procurement cost of control power by 50%, presumably permitting lower prices for end consumers. 

The literature on the effect of VRES on electricity supply is broader. They generally focus on both variability of supply and prices. Amongst them: @pereiradasilva2019 who use EGARCH time series and regression while studying the Iberian power market; @frauendorfer2018 who find that the Swiss are "importing" lower German power prices during peak solar production, as Germany has much more solar energy sources than the Swiss. Finally, the authors @dong2019 find that the Swedes have more stable prices due to the relatively high proportion of non variable fossil and hydropower than the Danes, who are more reliant on VRES in the form of wind and solar. Other studies in the area are more conflicted, such as @rintamäki2017 who compare Germany and Danish prices and wind that the effect of increasing wind production on day ahead prices is not constant. The point is that increasing VRES leads to variability in supply, which presumably means more cost for balancing out an unpredictable supply when the predictions are wrong.

## Scope of Analyis
The main question we want to analyse is whether increased variable renewable energy production on the Swiss grid realates to higher cost for control energy.

In the following chapter the data sources used for the analysis will be described followed by a data exploration. The further analysis is then performed using Time Series Modelling methods.

It is the purpose of this study to see whether and if so, to what extent renewable energy sources are related to increasing costs of control energy.
\newpage 

# Data Sources
## Data source for control energy
Swissgrid provides a variety of data about electricity in Switzerland, which they make publicly available.[^Swissgrid1] They provide the data in intervals of 15\ minutes. It can be downloaded as a .xls or .xlsx file per year. The time period of the data used in the following analysis ranges from the beginning of 2015 until the end of July 2024.
They provide data about the electricity production and consumption for Switzerland and for the individual cantons. Additionally, they also provide the information about control energy (amount and prize), split up in positive and negative as well as secondary and tertiary. There is no data provided about primary control energy.
They state that "The data are reliable from 6 months onwards, until then the partners from the electricity sector who provide Swissgrid with the data can still claim changes."[^Swissgrid1-gen]. This should be kept in mind for the time period of 2024.

[^Swissgrid1-gen]: <https://www.swissgrid.ch/en/home/operation/grid-data/generation.html>

The following table shows an excerpt of the data provided by Swissgrid with an example value.

```{r Table-Swissgrid-Data, include = TRUE, echo=FALSE, message=FALSE, warning=FALSE}

# Read the column names and one sample row from the Excel file
data.example <- read_excel("EnergieUebersichtCH-Example-Data.xlsx",
                           sheet = "Zeitreihen0h15",
                           col_names = FALSE,
                           range = "A1:BM3")

# function to handle splitting of column names
extract_english_part <- function(text) {
  parts <- strsplit(text, "&Linebreak%")[[1]]
  if (length(parts) >= 2) {
    return(parts[2])
  } else {
    return(text)
  }
}

# Extract English column names
v.english_column_names <- sapply(data.example[1, ], extract_english_part)

# Get units and example data row
v.units <- unlist(data.example[2, ])
v.example_data_row <- unlist(data.example[3, ])

# Combine into a new data frame
d.info_df <- data.frame(Column_Name = v.english_column_names,
                        Type = v.units,
                        Example_Value = v.example_data_row)

# Create kable, which will be output
kable(d.info_df, row.names = FALSE,
      caption = "Data provided from Swissgrid",
      col.names = c("column name", "type", "example value"))
```

\newpage
## Data Source for generation share of wind and solar (hourly)
To obtain the percentage of VRES data from the transparency platform from the European Network of Transmission System Operators for Electricity (enstsoe) was used.[^entsoeSource1] After creating an account the data about grid forecast and load ("Actual Total Load [6.1.A]" and "Day-ahead Total Load Forecast [6.1.B]") and the actual generation per production type ("Aggregated Generation per Type [16.1.B&C]") can be obtained. They provide the data in intervals of 1\ hour and the data can be downloaded as a .csv file with a time span of 1 year. The data was obtained for the same time period as the data from Swissgrid and combined for further analysis.
The following table shows an excerpt of the data with an example value.

[^entsoeSource1]: https://transparency.entsoe.eu/

```{r Table-Entsoe-Data, include = TRUE, echo=FALSE, message=FALSE, warning=FALSE}
# Extract column names
v.column_names <- c(colnames(df_gen_load_raw))

# Get example data row
v.example_data_row <- unlist(as.vector(df_gen_load_raw[10, ]))

# Combine into a new data frame
d.info_df <- data.frame(Column_Name = v.column_names,
                        Example_Value = v.example_data_row)

# Create kable, which will be output
kable(d.info_df, row.names = FALSE,
      caption = "Data provided from entsoe",
      col.names = c("column name", "example value"))
```

Many columns could be omitted after loading since they contained only "NA" values for every row (for example "Fossil Brown coal/Lignite - Actual Aggregated [MW]" which is not used to produce electricity in Switzerland).

Using this data the percentage of variable renewable energy sources was calculated using the following formula:
$$
\text{`VRES\_percent`} = \frac{\text{`Solar-Actual Aggregated [MW]`} + \text{`Wind Onshore-Actual Aggregated [MW]`}}{\text{`Actual Total Load [MW] - BZN|CH)`}}
$$

## Data Source for generation share of wind and solar (daily)
The data of the energy production in Switzerland by production type was obtained from opendata.swiss[^opendataswiss1]. They provide the data in intervals of 1\ day and the data can be downloaded as a .csv file. The data provides the date, the production type and the production in GWh. The following table shows an excerpt of the data with an example value. From this data the production of VRES was calculated as the sum of the produced wind energy and solar energy.

[^opendataswiss1]: https://opendata.swiss/en/dataset/energiedashboard-ch-stromproduktion-swissgrid/resource/619e6fa0-7c2b-46dd-9633-7bd60fc5ec16

```{r Table-opendata-production, include = TRUE, echo=FALSE, message=FALSE, warning=FALSE}
energy_production <- read_csv("ogd104_stromproduktion_swissgrid.csv",
                              col_types = "c")

# Extract column names
v.column_names <- c(colnames(energy_production))

# Get example data row
v.example_data_row <- unlist(as.vector(energy_production[10, ]))

# Combine into a new data frame
d.info_df <- data.frame(Column_Name = v.column_names,
                        Example_Value = v.example_data_row)

# Create kable, which will be output
kable(d.info_df, row.names = FALSE,
      caption = "Data of daily energy production by type",
      col.names = c("column name", "example value"))
```

## Data Source for electricity price
The data of the electricity price (spot market day-ahead Base) was obtained from opendata.swiss[^opendataswiss2]. They provide the data in intervals of 1\ day and the data can be downloaded as a .csv file. The data provides the date and the price on the energy market for the following day for base-load energy. The following table shows an excerpt of the data with an example value.

[^opendataswiss2]: https://opendata.swiss/de/dataset/energiedashboard-ch-energiepreise/resource/93f2ba7e-19c4-423f-a9c2-4026da4f131b

```{r Table-opendata-electricity-prices, include = TRUE, echo=FALSE, message=FALSE, warning=FALSE}
energy_production <- read_csv("ogd106_preise_strom_boerse.csv",
                              col_types = "c")

# Extract column names
v.column_names <- c(colnames(energy_production))

# Get example data row
v.example_data_row <- unlist(as.vector(energy_production[10, ]))

# Combine into a new data frame
d.info_df <- data.frame(Column_Name = v.column_names,
                        Example_Value = v.example_data_row)

# Create kable, which will be output
kable(d.info_df, row.names = FALSE,
      caption = "Data of day-ahead electricity prices on the spot market",
      col.names = c("column name", "example value"))
```

\newpage
# Data exploration
## Cost of control energy

The cost of control energy was aggregated per year to investigate the trend over the years. The Time-Series analysis in the following chapter will further investigate the fluctuations of the cost during the year / days.

The following plot shows the development of the cost Swissgrid spent on control energy over the years. The expenditure stayed relatively stable until the year of 2020, followed by an increase in 2021 and a big increase in the 2022. From 2023 the cost decreased but remained significantly above the average costs of the years before 2021.

```{r, Data exploration_Plot control cost total, include = TRUE, echo = FALSE, cache = TRUE, fig.dim = c(7, 3)}
# Cost aggregated by Year
# Extract the year from the 'Timestamp' column
d.h$year <- year(d.h$Timestamp)

# Identify exact duplicate rows
duplicate_rows <- d.h[duplicated(d.h) | duplicated(d.h, fromLast = TRUE),]
# no dublicate rows

# Reshape the data into long format, selecting all four relevant columns
d.h_long <- d.h %>%
  filter(year != 2024) %>%  # Exclude the year 2024
  pivot_longer(cols = c(cost_pos_sec_EUR, cost_neg_sec_EUR, cost_pos_ter_EUR, cost_neg_ter_EUR), 
               names_to = "cost_type", values_to = "cost_value")

d.h_long$cost_type <- factor(d.h_long$cost_type,
                             levels = c("cost_neg_sec_EUR",
                                        "cost_pos_sec_EUR",
                                        "cost_neg_ter_EUR",
                                        "cost_pos_ter_EUR"))
# Group by 'year' then summarize the total cost
df_yearly_cost <- d.h_long %>%
  group_by(year) %>%
  summarise(total_cost = sum(cost_value, na.rm = TRUE)) %>%
  ungroup()

ggplot(data = df_yearly_cost, aes(x = as.factor(year), y = total_cost / 1e6, group = 1)) + 
  # Add solid lines at every 100 Mio
  geom_hline(yintercept = seq(0, 300, by = 100),
             linetype = "solid", color = "darkgrey") +
  geom_hline(yintercept = 0,
             linetype = "solid", color = "black") +
  geom_line(color = "red", linewidth = 1) +
  geom_point(color = "red", size = 2) +
  ggtitle("Total Cost of Control Energy") +
  xlab("Year") +
  ylab("Total Cost [EUR]") +
  scale_y_continuous(labels = label_number(suffix = " Mio", big.mark = ","),
                     expand = expansion(mult = c(0.1, 0.1))) +
  scale_x_discrete(expand = expansion(mult = c(0.1, 0.1))) +
  theme_minimal() +
  theme(legend.title = element_blank(),  # Hide the legend title
  plot.title = element_text(hjust = 0.5),
  plot.title.position = "plot")
```

In the following plot the cost is split up into the cost for the secondary and tertiary control energy (positive and negative). The plot highlights trends in the costs associated with these control energy types. For the years of 2021 to 2023 a substantial negative cost (profit) is shown for the negative tertiary control energy. The positive tertiary control energy shows as the biggest contributor of the overall costs.

```{r, Data exploration_Plot control cost separated,include = TRUE, echo = FALSE, cache = TRUE, fig.dim = c(7, 3)}
# Group by 'year' and 'cost_type', then summarize the total cost for each
df_yearly_cost <- d.h_long %>%
  group_by(year, cost_type) %>%
  summarise(total_cost = sum(cost_value, na.rm = TRUE), .groups = 'drop') 

# Create a bar plot for the sum of costs per year, with different colors for each 'cost_type'
ggplot(df_yearly_cost, aes(x = as.factor(year), y = total_cost / 1e6, fill = cost_type)) +  # Y-axis in millions
  # Add solid lines at every 100 Mio
  geom_hline(yintercept = seq(-100, 400, by = 100),
             linetype = "solid", color = "darkgrey") +
  geom_hline(yintercept = 0,
             linetype = "solid", color = "black") +
  # Add bar plot
  geom_bar(stat = "identity", position = position_dodge(width = 0.9),
           color = "black") +  # Dodge to separate the bars
  ggtitle("Costs of Secondary and Tertiary Control Energy") +
  xlab("Year") +
  ylab("Total Cost [EUR]") +
  # Format y-axis
  scale_y_continuous(labels = label_number(suffix = " Mio", big.mark = ","),
                     breaks = seq(-100, 400, by = 100),
                     minor_breaks = seq(-100, 400, by = 50),
                     expand = expansion(mult = c(0.05, 0.05))) +
  # Custom colors and labels
  scale_fill_manual(values = c("skyblue2", "lightblue1", "gold", "yellow"), 
                    breaks = c("cost_neg_sec_EUR", "cost_pos_sec_EUR",
                               "cost_neg_ter_EUR", "cost_pos_ter_EUR"),
                    labels = c("neg. Sec.", "pos. Sec.",
                               "neg. Ter.", "pos. Ter.")) +  
  scale_x_discrete(expand = expansion(mult = c(0.1, 0.1))) +  
  theme_minimal() +
  theme(legend.title = element_blank(),  # Hide the legend title
  plot.title = element_text(hjust = 0.5),
  plot.title.position = "plot")

```


## Overview Variable Renewable Energy Sources
### Solar and Wind power generation
The following graphs show the power generation of solar and wind power in Switzerland using the available hourly data from the entsoe platform ([Data Source for generation share of wind and solar (hourly)]).
The first graph prints the values "as-is" which basically creates a plot where the peak values are displayed. The second plot uses a moving-average (`SMA`) over 24 hours, which displays the average production during a day.
The graphs show a clear seasonality for the solar power (increased production during the summer). The wind power makes up a small fraction of the power production compared to solar power, especially considering the graphs with the peak hours.

```{r, Data exploration_Plot wind solar hourly,include = TRUE, echo = FALSE, cache = TRUE, fig.dim = c(7, 3)}
ggplot(d.h) + 
  # Solar generation in the background
  geom_line(aes(x = Timestamp, y = CH_solar_generation_actual_MW, color = "Solar"), linewidth = 1) + 
  # Wind generation in the foreground
  geom_line(aes(x = Timestamp, y = CH_wind_onshore_generation_actual_MW, color = "Wind"), linewidth = 1) + 
  ggtitle("Wind and Solar power generation (peak hours)") +
  xlab("Date") +
  ylab("Generation (MW)") +
  scale_color_manual(values = c("Wind" = "blue", "Solar" = "orange")) + 
  theme_minimal() +
  geom_hline(yintercept = 0,
             linetype = "solid", color = "black") +
  labs(color = "Generation Type") + 
  theme(plot.title = element_text(hjust = 0.5), plot.title.position = "plot")
```


```{r, Data exploration_Plot wind solar hourly MA,include = TRUE, echo = FALSE, cache = TRUE, fig.dim = c(7, 3)}
# Daily Moving Average
# Plot the filtered data with wind in the foreground and solar in the background
ggplot(d.h) + 
  # Solar generation in the background
  geom_ma(ma_fun= SMA, n = 24, aes(x = Timestamp, y = CH_solar_generation_actual_MW, color = "Solar"), linewidth = 1) +

# Wind generation in the foreground
  geom_ma(ma_fun= SMA, n = 24, aes(x = Timestamp, y = CH_wind_onshore_generation_actual_MW, color = "Wind"), linewidth = 1) + 
  ggtitle("Wind and Solar power generation (24h moving average)") +
  xlab("Time") +
  ylab("Generation (MW)") +
  scale_color_manual(values = c("Wind" = "blue", "Solar" = "orange")) + 
  theme_minimal() +
  geom_hline(yintercept = 0,
             linetype = "solid", color = "black") +
  labs(color = "Generation Type") + 
  theme(plot.title = element_text(hjust = 0.5), plot.title.position = "plot")
```

With the solar production there seems to be a big change from end of 2019 to beginning of 2020. Up until that moment the production remains low and quite constant over the years. After that the production increases by a factor of approximately 5. It is assumed that the reporting of the data was changed with the start of the year 2020, for example by newly taking into account the production of solar power at individual households. But no source could be found which explained this described change in the production.

Using the daily data from a different data source ([Data Source for generation share of wind and solar (daily)]) there is no jump in production at the start of 2020. This can be seen in the following graph showing development of the daily energy production (in GWh) using this data. The values after the year 2020 are comparable using the different data sets (can be compared by multiplying the 24h moving average by 24 hours).

```{r, Data exploration_Plot wind solar daily,include = TRUE, echo = FALSE, cache = TRUE, fig.dim = c(7, 3)}
# Plot the Daily Generation with wind in the foreground and solar in the background
ggplot(d.d) + 
  # Solar generation in the background
  geom_line(aes(x = Date, y = Photovoltaic_GWh,
                color = "Solar"), linewidth = 1) + 
  # Wind generation in the foreground
  geom_line(aes(x = Date, y = Wind_GWh, color = "Wind"), linewidth = 1) + 
  ggtitle("Wind and Solar power generation (daily data)") +
  xlab("Date") +
  ylab("Generation (GWh)") +
  scale_color_manual(values = c("Wind" = "blue", "Solar" = "orange")) + 
  theme_minimal() +
  geom_hline(yintercept = 0,
             linetype = "solid", color = "black") +
  labs(color = "Generation Type") + 
  theme(plot.title = element_text(hjust = 0.5), plot.title.position = "plot")
```

### Percentage of VRES
The graph below displays VRES\_percent (Variable Renewable Energy production in Switzerland as a percentage of energy consumed) over time. A clearly cyclical  pattern can be identified, indicating the presence of seasonality, which is expected due to the seasonal nature of solar energy production. The effect at the beginning of 2020 is reflected in this graphs as well since the calculation of the percentage of VRES is done using the hourly data of the power generation.

The maximum value has been pushed up noticeably every year since 2020 and almost reached 60%. This high value represents a peak hour. When looking at the moving average, where each dot represents the average contribution over a 24 hour period, this share is lowered significantly, still reaching a contribution of 20% to the daily energy consumed in the last recorded summer of 2024. 

```{r, Data exploration_VRES peak,include = TRUE, echo = FALSE, cache = TRUE, fig.dim = c(7, 3)}
# VRES_percent Range
min_VRES <- min(d.h$VRES_percent, na.rm = TRUE)
max_VRES <- max(d.h$VRES_percent, na.rm = TRUE)

# Plot the filtered data
ggplot(d.h, aes(x = Timestamp, y = VRES_percent * 100)) + 
  geom_line(color = "blue", linetype = "solid", linewidth = 0.5) + 
  ggtitle("VRES percentage (peak hour)") +
  xlab("Time") +
  ylab("VRES percentage") +
  scale_y_continuous(labels = scales::label_number(suffix = "%")) + 
  theme_minimal() +
  geom_hline(yintercept = 0,
             linetype = "solid", color = "black") +
  theme(plot.title = element_text(hjust = 0.5), plot.title.position = "plot")
```


```{r, Data exploration_VRES MA,include = TRUE, echo = FALSE, cache = TRUE, fig.dim = c(7, 3)}
# Moving Average
ggplot(d.h)+ 
  geom_ma(ma_fun= SMA, n = 24, aes(x = Timestamp, y = VRES_percent* 100),
          linetype = "solid", linewidth = 0.5) + 
  ggtitle("VRES percentage (24h moving average)") +
  xlab("Time") +
  ylab("VRES percentage") +
  scale_y_continuous(labels = scales::label_number(suffix = "%")) + 
  theme_minimal() +
  geom_hline(yintercept = 0,
             linetype = "solid", color = "black") +
  theme(plot.title = element_text(hjust = 0.5), plot.title.position = "plot")
```

\newpage
# Time Series Analysis 
## Analysis of Control Energy Costs
### Visualization of Control Energy Costs

```{r, vres ts prep1, include = FALSE, warning = F}
# Convert the Timestamp column to a Date-Time object
d.h$Timestamp <- as.POSIXct(d.h$Timestamp, format="%Y-%m-%d %H:%M:%S")

# Replace NAs in 'VRES_percent' with zero
d.h$VRES_percent[is.na(d.h$VRES_percent)] <- 0

# Convert VRES_percent into a time series object
VRES_ts <- ts(d.h$VRES_percent, start=c(2015, 1), frequency=24*365.25)  # Assuming hourly data
```

The first plot illustrates the cost of control energy over time, measured in EUR, from 2015 through 2024. The x-axis represents the time period, while the y-axis reflects the hourly control energy costs in EUR. 

The graph reveals an overall increasing trend in control costs as time progresses, with periods of volatility that become more pronounced starting in late 2020. The costs were relatively stable from 2015 until 2020, with only minor spikes. A noticeable rise in both the frequency and magnitude of cost fluctuations is observed from 2021 onward. This suggests that control energy costs became more volatile, with significant spikes emerging around 2022 and peaking in late 2023 and early 2024.

```{r, plot ts of control cost, echo = FALSE, warning = F, message = F, fig.dim = c(7, 3)}
# Create the plot for VRES_percentage
ggplot(d.h, aes(x = as.Date(Timestamp), y = total_cost_EUR)) +
  geom_line(color = "darkblue") +                     
  scale_x_date(date_breaks = "1 year", date_labels = "%Y",
               limits = c(as.Date("2015-01-01"), as.Date("2024-11-30"))) +
  scale_y_continuous(labels = label_number(big.mark = "'"),
                     breaks = seq(0, 8000000, by = 2000000)) +
  labs(title = "Cost of Control Energy Over Time",
       x = NULL, 
       y = "Cost in EUR") +
  theme_minimal() +
  geom_hline(yintercept = 0,
             linetype = "solid", color = "black") +
  theme(plot.title = element_text(hjust = 0.5), plot.title.position = "plot")
```

One notable aspect of the data is the presence of multiple sharp peaks, indicating sudden surges in costs, which likely correspond to times of increased demand for control energy. These peaks, reaching prices beyond EUR 8\ million per hour, imply high operational costs during these periods. Additionally, there are moments where the costs drop to zero or even become negative. Negative costs could imply that Swissgrid occasionally earns money, likely through balancing mechanisms when energy supply exceeds demand, thus allowing the sale of excess energy to other countries.

### Decomposition of Control Energy Costs

```{r, costs ts prep, include = FALSE, warning = F}
# Convert the Timestamp column to a Date-Time object
d.h$Timestamp <- as.POSIXct(d.h$Timestamp, format="%Y-%m-%d %H:%M:%S")

# Replace NAs in 'total_cost_EUR' with zero
d.h$total_cost_EUR[is.na(d.h$total_cost_EUR)] <- 0

# Convert total_cost_EUR into a time series object
total_cost_EUR_ts <- ts(d.h$total_cost_EUR, start = c(2015, 1), end = c(2024, 8), frequency=24*365.25)
```

```{r, costs additive decomposition, echo = FALSE, warning = F, fig.dim = c(7, 4)}
# Decompose the time series
cost_decomposed <- decompose(total_cost_EUR_ts)

# Plot the decomposed time series
plot(cost_decomposed,
     xlab = "Time", ylab = "Cost in EUR", 
     cex.lab = 0.8, oma=c(2.5,2.5,2,1), mar = c(0.1,6,0.2,0.2), 
     cex.axis = 0.8, las = 1, cex.main = 0.85)
title(main = "Decomposition of additive time series", cex.main = 0.9,
      line = 3.2)
```

The  decomposition into trend, seasonal, and remainder components provides insights into the underlying structure of the control cost data. 
The trend component reveals an upward trajectory starting in late 2020, peaking in mid-2023, and slightly declining towards the end of the observation period. This indicates that control costs were steadily increasing over time. The seasonal component exhibits recurring peaks and troughs, which suggests the presence of consistent, cyclical patterns in the control costs. These seasonal fluctuations could be linked to predictable changes in energy demand or production patterns, such as variations in solar and wind power generation.

The remainder (random) component still displays a substantial amount of unexplained variance, especially towards the later years of the time series. There is notable volatility in this component, which could be attributed to external factors or events not captured by the trend or seasonality, such as sudden shifts in energy market conditions or unexpected changes in demand.

Given this, while the decomposition successfully highlights the importance of the trend and seasonal components, the remainder indicates a significant level of residual variability that could require further exploration. We believe that exogenous factors, like the war in the Ukraine, have contributed to increased noise in the remainder, starting in 2022. To control for these factors, in the next section, we will consider the time period up to end of 2021.

\newpage
### Stationarity of Control Energy Costs

For the time series analysis of control energy costs, achieving stationarity is important to ensure valid modeling results. 
Initially, the original time series showed signs of non-stationarity, with an increasing trend and rising variance over time. This non-constant behavior is particularly evident due to the sharp cost increases in certain periods.
Given the multiplicative nature of the data, a log transformation was first applied to stabilize the variance, addressing the large fluctuations in the original series.

```{r, differencing of cost, echo = FALSE, warning = FALSE, fig.dim = c(7, 3)}
# Reflect period until end of 2021
total_cost_EUR_ts <- ts(d.h$total_cost_EUR, start = c(2015, 1), end = c(2021, 12), frequency=24*365.25)

# Apply log transformation (add a small constant to avoid log(0) issues)
costs_log <- log(total_cost_EUR_ts + 1e-6)

# Apply first-order differencing to remove the trend
costs_log_diff <- diff(costs_log, differences = 1)
# sum(is.na(costs_log_diff))
costs_log_diff <- na.approx(costs_log_diff)
# sum(is.na(costs_log_diff))

# Save current par settings
old_par <- par(no.readonly = TRUE)

# Adjust graphical parameters
par(cex.lab = 0.8, cex.axis = 0.75, cex.main = 0.85)

# Plot the differenced series
plot(costs_log_diff, main="Differenced Total Costs Time Series")

# Reset to original par settings
par(old_par)
```

Following the log transformation, first-order differencing was applied to remove the trend from the time series. While this step successfully eliminated much of the trend, the resulting series still showed signs of variation over time, indicating the presence of seasonality. The plot of the differenced series showed reduced but not entirely constant variance, suggesting that further adjustments were needed.

```{r, differencing seasonal cost, echo = FALSE, warning = FALSE, fig.dim = c(7, 3)}
# Apply seasonal differencing (assuming yearly seasonality with a frequency of 365)
costs_log_diff_seasonal <- diff(costs_log_diff, lag = 365)

# Save current par settings
old_par <- par(no.readonly = TRUE)

# Adjust graphical parameters
par(cex.lab = 0.8, cex.axis = 0.75, cex.main = 0.85)

# Plot the seasonally differenced series
plot(costs_log_diff_seasonal, 
     main="Seasonally Differenced Total Costs Time Series")

# Reset to original par settings
par(old_par)
```

To address the cyclical nature of the data, seasonal differencing with a lag of 365 (corresponding to annual seasonality) was applied. This step accounted for recurring yearly patterns, resulting in a more stationary time series. The second plot, "Seasonally Differenced Total Costs Time Series", demonstrates that the variance has been more effectively stabilized compared to the non-seasonally differenced series.

\newpage

```{r, costs adf, echo = FALSE, warning = FALSE}
# Perform Augmented Dickey-Fuller test
adf.test(costs_log_diff_seasonal)
```

Finally, an Augmented Dickey-Fuller (ADF) test was performed on the seasonally differenced series, yielding a p-value smaller than 0.01. This result indicates that the null hypothesis of non-stationarity can be rejected with high confidence, confirming that the seasonally differenced series is stationary.
The combined use of log transformation, first-order differencing, and seasonal differencing ensures that the time series is stationary. This stationarity is crucial for the validity of subsequent modeling, particularly when analyzing the control costs up to the end of 2021 to avoid confounding effects from external shocks like the war in Ukraine.

## Analysis of hourly Percentage of Variable Renewable Energy Sources (VRES)
The VRES development of the VRES percentage is visualized and described in Chapter\ 4.2.1.

### Decomposition of hourly Percentage of VRES
```{r, vres ts prep2, include = FALSE, warning = F}
# Convert the Timestamp column to a Date-Time object
d.h$Timestamp <- as.POSIXct(d.h$Timestamp, format="%Y-%m-%d %H:%M:%S")

# Replace NAs in 'VRES_percent' with zero
d.h$VRES_percent[is.na(d.h$VRES_percent)] <- 0

# Convert VRES_percent into a time series object
VRES_ts <- ts(d.h$VRES_percent, start = c(2015, 1), end = c(2024, 8), frequency=24*365.25)
```
The below plot shows the decomposition of the VRES time series. The observed panel shows seasonal peaks occurring annually, reflecting the cyclical nature of renewable energy generation. The trend component shows a relatively flat trajectory until 2019, after which there is a noticeable upward shift, indicating a substantial increase in VRES share from 2020 onwards. While this upward trend aligns with the growing share of renewable energy sources in the grid, especially solar and wind energy, there is also the effect of the big change between end of 2019 and start of 2020 as described in Chapter\ 4.2.1 to take into consideration.

```{r, vres additive decomposition, echo = FALSE, warning = FALSE, fig.dim = c(7, 3.6)}
# Decompose the time series
VRES_decomposed <- decompose(VRES_ts)

# Plot the decomposed time series
plot(VRES_decomposed,
     xlab = "Time", 
     cex.lab = 0.8, oma=c(2.5,2.5,2,1), mar = c(0.1,6,0.2,0.2), 
     cex.axis = 0.8, las = 1, cex.main = 0.85)
title(main = "Decomposition of additive time series", cex.main = 0.9,
      line = 3.2)
```

The seasonal component exhibits a clear and consistent annual pattern, with large, predictable peaks occurring each year. These peaks are indicative of the regular variation in renewable energy production, likely driven by seasonal factors such as weather patterns, which affect solar radiation and wind speeds. The random component shows some variations, indicating that there may be structures in the data that is not captured by the trend and seasonal components. In fact, the random component does show increased variability in the later years, which may correspond to irregularities or external shocks affecting renewable generation.

Given the observed trend and seasonality, the analysis of VRES' impact on control costs will focus on the data up to the end of 2021, thereby excluding the post-2021 period where external factors (such as the war in Ukraine) may have contributed to increased volatility.

### Stationarity hourly Percentage of VRES

We are now turning to the stationarity analysis, which will prepare the data for use in a vector autoregression (VAR) model and Granger cusality test aimed at forecasting control costs using VRES as a key predictor.

```{r, vres adf1, echo = FALSE, warning = F}
# Perform Augmented Dickey-Fuller test
adf.test(VRES_ts)
```

The Augmented Dickey-Fuller test of the VRES time series has a p-value of 0.01 although the decomposition clearly shows a trend, seasonality and also a change in randomness. We suspect a decomposition of a multiplicative time series might help. A multiplicative decomposition assumes that the components (trend, seasonality, and noise) interact in a multiplicative manner. This is often suitable when the variability of the time series increases as the level of the series increases, which might be indicated by the trend and seasonal patterns with the overall level.

Applying a log transformation to the data can stabilize the variance, which often makes the series more appropriate to decomposition or modeling. The log-transformation essentially converts a multiplicative relationship into an additive one.

```{r, vres multiplicative decomposition, echo = FALSE, warning = F, fig.dim = c(7, 4)}

# Apply log transformation (add a small constant to avoid log(0) issues)
VRES_log <- log(VRES_ts + 1e-6)

# Decompose the log-transformed time series
VRES_log_decomposed <- decompose(VRES_log)
plot(VRES_log_decomposed,
     xlab = "Time", 
     cex.lab = 0.8, oma=c(2.5,2.5,2,1), mar = c(0.1,6,0.2,0.2), 
     cex.axis = 0.8, las = 1, cex.main = 0.85)
title(main = "Decomposition of log-transformed additive time series", cex.main = 0.9,
      line = 3.2)
```
The decomposition of the log-transformed series still reveals a clear upward trend and significant seasonality, indicating that the series is not yet stationary despite an initial low p-value from the Augmented Dickey-Fuller test. This suggests that, while the variance was stabilized, the time series still contains structural components (trend and seasonal patterns) that need to be addressed. Therefore, the next steps involve applying first-order differencing to remove the underlying trend and seasonal differencing to eliminate cyclical variations. These transformations will help ensure the series is stationary.

```{r, vres differencing, echo = FALSE, warning = F, fig.dim = c(7, 3)}
# Apply first-order differencing to the log-transformed series
VRES_log_diff <- diff(VRES_log)

# Plot the differenced series
# plot(VRES_log_diff, main="Differenced Log-Transformed VRES Time Series")

# Apply seasonal differencing
VRES_log_seasonal_diff <- diff(VRES_log_diff, lag = 365)
# sum(is.na(VRES_log_seasonal_diff))

# Save current par settings
old_par <- par(no.readonly = TRUE)

# Adjust graphical parameters
par(cex.lab = 0.8, cex.axis = 0.75, cex.main = 0.85)

# Plot the seasonally differenced log-transformed series
plot(VRES_log_seasonal_diff,
     main="Seasonally Differenced Log-Transformed VRES Time Series")

# Reset to original par settings
par(old_par)
```

The resulting seasonally differenced, log-transformed series exhibits fluctuations around a constant mean with stable variance, as shown in the "Seasonally Differenced Log-Transformed VRES Time Series" plot. 

```{r, vres seasonally diff decomposition, echo = FALSE, warning = F, fig.dim = c(7, 4)}

VRES_log_seasonal_diff_decomp <- decompose(VRES_log_seasonal_diff)

plot(VRES_log_seasonal_diff_decomp,
     xlab = "Time", 
     cex.lab = 0.8, oma=c(2.5,2.5,2,1), mar = c(0.1,6,0.2,0.2), 
     cex.axis = 0.8, las = 1, cex.main = 0.85)
title(main = "Decomposition of seasonally differenced log-transformed additive time series", cex.main = 0.9,
      line = 3.2)
```

The decomposition of the differenced series confirms the absence of any significant remaining trend or seasonal patterns, with most variation captured in the random component. To verify stationarity, an Augmented Dickey-Fuller test was conducted, yielding a test statistic of -65.948 and a p-value smaller than 0.01. This result also rejects the null hypothesis of non-stationarity, indicating that the series is now stationary. The series is now ready for further analysis, such as Vector Autoregression (VAR), to assess its relationship with control costs.

```{r, stationarity vres, echo = FALSE, warning = FALSE}
adf.test(VRES_log_seasonal_diff)
```

```{r, vres sarima, include = FALSE, echo = FALSE, warning = F}

# Fit a SARIMA model using auto.arima
#sarima_model_h <- auto.arima(VRES_ts, seasonal = TRUE)

# Summary of the SARIMA model
#summary(sarima_model_h)

# Check residuals of the SARIMA model
#checkresiduals(sarima_model_h)

```

```{r, vres forecasting, include = FALSE, echo = FALSE, warning = F}
# Forecast the next 365 periods (adjust as needed)
#sarima_forecast_h <- forecast(sarima_model_h, h = 365)

# Plot the forecast
#plot(sarima_forecast_h)

```

## Analysis of Impact of VRES percentage on Control Energy Costs
### Vector Autoregression (VAR)

The next step in the analysis is to apply a Vector Autoregression (VAR) model to assess the linear interdependencies between time series. In this case, the VAR model will be used to analyze the dynamic relationship between VRES and control costs. By incorporating both the stationary VRES and control cost time series, the VAR model will help identify how changes in VRES affect control costs over time while accounting for the lagged effects of each variable on the other. We hope to provide insights into the impact of renewable energy integration on the grid's operational costs. We start by determining the optimal lag length.

```{r, align length time series, include = FALSE, echo = FALSE, warning = FALSE}
# Reflect period until end of 2021
VRES_ts <- ts(d.h$VRES_percent, start = c(2015, 1), end = c(2021, 12), frequency=24*365.25)

# Apply log transformation (add a small constant to avoid log(0) issues)
VRES_log <- log(VRES_ts + 1e-6)

# Apply first-order differencing to the log-transformed series
VRES_log_diff <- diff(VRES_log)

# Apply seasonal differencing
VRES_log_seasonal_diff <- diff(VRES_log_diff, lag = 365)

# Check length
length(costs_log_diff_seasonal)
length(VRES_log_seasonal_diff)

# Check for NAs
sum(is.na(costs_log_diff_seasonal))  # Check for NAs in costs_log_diff
sum(is.na(VRES_log_seasonal_diff))  # Check for NAs in VRES_log_seasonal_diff
```

```{r, lag length var, echo = TRUE, warning = F}
# Determine lag length
VARselect(cbind(costs_log_diff_seasonal, VRES_log_seasonal_diff), 
          lag.max = 10, type = "const")
```

The lag length selection process indicates that the optimal lag length is 10 according to all criteria (AIC, HQ, SC, and FPE). This suggests that incorporating 10 lags will provide the best model fit while capturing the dynamics between the differenced control costs and VRES time series. With this optimal lag length determined, the next step is to estimate the VAR model and analyze the interactions between the variables.

```{r, var model, echo = TRUE, warning = FALSE, cache = TRUE}
var_model <- VAR(cbind(costs_log_diff_seasonal, VRES_log_seasonal_diff), 
                 p = 10, type = "const")
```

```{r, var model2, echo = FALSE, warning = FALSE, cache = TRUE}
options(width = 60)
model_summary_text <- capture.output(summary(var_model))

break_lines <- function(chr_vector, max_length = 84) {
  for (line in chr_vector) {
    while (nchar(line) > max_length) {
      cat(substr(line, 1, max_length), "\n")
      line <- substr(line, max_length + 1, nchar(line))
    }
    cat(line, "\n")
  }
}

break_lines(model_summary_text)
```

The results of the VAR model estimation provide valuable insights into the dynamic relationship between control costs and VRES. For the equation predicting control costs (costs_log_diff_seasonal), several lags of the VRES variable are significant. Specifically, VRES at lags 1, 4, 6, 7, and 10 have significant coefficients, indicating that changes in VRES have both immediate and delayed effects on control costs. For instance, the negative coefficient for the first lag of VRES (-0.0139, p = 0.004) suggests that an increase in VRES has a small but statistically significant immediate downward impact on control costs. Conversely, the positive coefficients at lags 4, 5, and 6 indicate that VRES fluctuations at earlier periods can lead to a subsequent rise in control costs. Overall, the F-statistic for this equation (978.4, p < 2.2e-16) and adjusted R-squared of 0.2723 suggest that the model explains a moderate portion of the variability in control costs, with a strong relationship captured over the 10 lags.

For the equation predicting VRES (VRES_log_seasonal_diff), most of the significant effects are driven by the variable's own lags, rather than control costs. VRES is highly influenced by its own history, with significant coefficients at many lags (1, 2, 3, 4, 5, and others), demonstrating the strong autocorrelation and persistence in renewable energy generation patterns. Control costs do not appear to significantly influence VRES, with only a few lags (such as lag 9 and 10) showing significant coefficients. The adjusted R-squared of 0.05423 for the VRES equation suggests that other factors, not captured in this model, likely explain the majority of the variation in VRES. The overall low correlation (0.001467) between the residuals of the two equations further confirms that VRES and control costs have a relatively low degree of direct correlation in the residual unexplained portions of the time series. Overall, the results imply that while VRES has a measurable impact on control costs, control costs have little reciprocal effect on VRES generation.

### Granger Causality Test

To further investigate the causal relationship between VRES  and control costs, a Granger causality test will be conducted. This test is designed to determine whether past values of one time series can help predict future values of another. Specifically, it will assess whether changes in VRES "Granger-cause" variations in control costs. By applying this test, we can determine if VRES has a predictive influence on control costs beyond their own historical patterns, solidifying the insights gained from the VAR model. This will provide a more in-depth understanding of the interactions between renewable energy penetration and grid operation costs.

```{r, granger, echo = TRUE, warning = FALSE}
# Perform Granger causality
causality(var_model, cause = "VRES_log_seasonal_diff")
```

The results of the Granger causality test provide strong evidence that VRES Granger-cause changes in control costs. The F-test statistic of 4.8896, with a very low p-value, allows us to confidently reject the null hypothesis that VRES does not Granger-cause control costs. This means that past values of VRES have predictive power over future variations in control costs, suggesting that fluctuations in renewable energy penetration directly influence the costs of maintaining grid stability. This reinforces the findings from the VAR model, where certain lags of VRES were found to have significant effects on control costs. However, the test for instantaneous causality between VRES and control costs yields a Chi-squared statistic of 0.11246 and a p-value of 0.7374, indicating no significant evidence of instantaneous causality between the two variables. In summary, VRES has a predictive, lagged impact on control costs, but the relationship is not instantaneous, highlighting the importance of considering the delayed effects of renewable energy integration on grid operation expenses.

## Analysis of Daily VRES Production
### Visualization of Daily VRES and non-VRES Production

The daily VRES production is shown and analyzed in Chapter 4.2.1. Photovoltaic production exhibits a clear seasonal pattern, with higher output during the summer months and lower production in winter, reflecting the natural variation in solar energy availability. In contrast, wind production (in grey) remains consistently low throughout the year with some fluctuations but no clear trend, indicating that wind energy may play a relatively small role in the overall energy production mix compared to photovoltaic energy.

The graph below compares VRES (Variable Renewable Energy Sources, including Photovoltaic and Wind) with Non-VRES (comprising Hydro, Nuclear, Storage, and Thermal energy). The Non-VRES sources (in black) dominate total energy production and display significant variability over time, driven by factors such as fluctuating demand and adjustments in non-renewable energy generation. VRES production (in green), while much lower in magnitude, shows a clear seasonal trend, largely driven by photovoltaic energy, with peaks in the summer months.

```{r, daily VRES non VRES visualization, echo = FALSE, warning = F, fig.dim = c(7,3)}
ggplot(d.d %>%
         select(Date, VRES_GWh, Non_VRES_GWh) %>%
         pivot_longer(cols = c(VRES_GWh, Non_VRES_GWh), 
                      names_to = "Source", 
                      values_to = "GWh"), 
  aes(x = as.Date(Date), y = GWh, color = Source)) +
  geom_line(linewidth = 1) +
  labs(title = "TVRES and Non-VRES Production",
       x = NULL, y = "Energy Production (GWh)") +
  scale_color_manual(values = c(
    "VRES_GWh" = "darkgreen", "Non_VRES_GWh" = "black")) +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y",
               limits = c(as.Date("2017-01-01"), as.Date("2024-11-30"))) +
  theme_minimal() +
  theme(legend.title = element_blank(),  # Hide the legend title
  plot.title = element_text(hjust = 0.5),
  plot.title.position = "plot")
```

### Decomposition of Daily VRES Production

```{r, decomposition, echo = FALSE, warning = F, fig.dim = c(7, 4)}
# Create a time series object for VRES production (Photovoltaic + Wind)
vres_ts_d <- ts(d.d$VRES_GWh, start = c(2017, 1), frequency = 365)

# Decompose the VRES time series
vres_decomp_d <- decompose(vres_ts_d)
# Plot the decomposed time series
plot(vres_decomp_d,
     xlab = "Time", 
     cex.lab = 0.8, oma=c(2.5,2.5,2,1), mar = c(0.1,6,0.2,0.2), 
     cex.axis = 0.8, las = 1, cex.main = 0.85)
title(main = "Decomposition of additive time series", cex.main = 0.9,
      line = 3.2)

# Check the first few values of each component
# head(vres_decomp_d$trend)
# head(vres_decomp_d$seasonal)
# head(vres_decomp_d$random)
```

The decomposition of the daily VRES energy production reveals a clear linear trend and strong seasonal patterns, with some variability in both the seasonal component and residuals. While the seasonal noise is expected due to the nature of renewable energy sources like photovoltaic and wind, it does not obscure the overall pattern. The fluctuations in the residuals suggest potential volatility of variance, but this can be addressed by examining the residuals further after modeling.

### Stationarity of Daily VRES Production

As in previous steps, we apply a log-transformation as well as regular differencing to remove the linear trend and since there is seasonality, we also apply seasonal differencing.

```{r, differencing vres, echo = FALSE, warning = F, fig.dim = c(7,3)}
# Apply log transformation (add a small constant to avoid log(0) issues)
vres_log_d <- log(vres_ts_d + 1e-6)

# Apply first-order differencing to the log-transformed series
vres_log_diff_d <- diff(vres_log_d)

# Apply seasonal differencing
vres_log_seasonal_diff_d <- diff(vres_log_diff_d, lag = 365)
# sum(is.na(vres_log_seasonal_diff_d))

# Save current par settings
old_par <- par(no.readonly = TRUE)

# Adjust graphical parameters
par(cex.lab = 0.8, cex.axis = 0.75, cex.main = 0.85)

plot(vres_log_seasonal_diff_d, 
     main = "Seasonally Differenced Log-Transformed Time Series", 
     ylab = "Differenced GWh", 
     xlab = NULL)

# Reset to original par settings
par(old_par)
```

```{r, decomposition vres, echo = FALSE, warning = F, fig.dim = c(7, 4)}
# Decomposition of fully differenced time series 
vres_log_seasonal_diff_d_decomp <- decompose(vres_log_seasonal_diff_d)

plot(vres_log_seasonal_diff_d_decomp,
     xlab = "Time", 
     cex.lab = 0.8, oma=c(2.5,2.5,2,1), mar = c(0.1,6,0.2,0.2), 
     cex.axis = 0.8, las = 1, cex.main = 0.85)
title(main = "Decomposition seasonally differenced log-transformed additive time series", cex.main = 0.9,
      line = 3.2)
```

```{r, vres stationarity, echo = TRUE, warning = FALSE}
# Perform ADF test to check stationarity
adf.test(vres_log_seasonal_diff_d)
```

The first plot presents the fully differenced series, which now fluctuates around a constant mean with reduced variance, indicating a more stable time series. The decomposition in the second plot confirms that both trend and seasonal components have been largely removed, leaving the random component as the main driver of variability. The results of the Augmented Dickey-Fuller (ADF) test confirm the stationarity of the differenced time series, with a Dickey-Fuller test statistic of -22.628 and a p-value smaller than 0.01, allowing us to reject the null hypothesis of non-stationarity. With the series now stationary, it is ready for further analysis

### Forecast of Daily VRES Production

After confirming the stationarity of the VRES daily time series, we proceeded with analyzing its Autocorrelation Function (ACF) and Partial Autocorrelation Function (PACF). The ACF plot (first image) reveals that after the first lag, the autocorrelations drop off quickly and remain within the confidence bounds, suggesting limited autocorrelation beyond the immediate past values. This indicates that the series does not exhibit strong long-term memory, and most of the autocorrelation is explained by the first few lags.

```{r, daily vres acf pacf, echo = FALSE, warning = F, fig.dim = c(7,2.6)}
# Save current par settings
old_par <- par(no.readonly = TRUE)

# Adjust graphical parameters
par(cex.lab = 0.8, cex.axis = 0.75, cex.main = 0.85, mar = c(4,3.8,3,1))

# ACF and PACF for the log-transformed differenced series
acf(vres_log_seasonal_diff_d)
pacf(vres_log_seasonal_diff_d)

# Reset to original par settings
par(old_par)
```

The PACF plot (second plot) shows a more gradual decline with significant negative partial autocorrelations up to lags beyond lag 10. This behavior suggests that a few past observations have a direct influence on the current value. We will now proceed with the SARIMA forecast.

```{r, daily vres_sarima model, echo = FALSE, warning = F, cache = T}
# Fit a SARIMA model with auto.arima to handle seasonality
sarima_model <- auto.arima(vres_ts_d, seasonal = TRUE)

# Summary of the fitted model
summary(sarima_model)
```

The fitted SARIMA(3,1,1)(0,1,0)[365] model effectively captures both short-term and seasonal patterns in the VRES time series. The significant autoregressive terms (especially AR1 at 0.3929) and the large negative moving average term (MA1 at -0.9766) indicate that recent past values and residuals from previous periods strongly influence future VRES values. The model shows a good fit with a sigma² of 7.477 and low residual autocorrelation (ACF1 = 0.0009), suggesting that most of the autocorrelation has been captured.

The residual analysis (plot below) further supports the model's adequacy: the residuals appear randomly distributed around zero, the ACF plot of residuals shows significant autocorrelations at the year mark, and the residuals’ histogram closely follows a normal distribution. Error metrics, including an RMSE of 2.547 and MAPE of 27.52%, indicate moderate forecasting accuracy, while the AIC (11819.13) and BIC (11848.12) confirm the model's parsimony. Overall, this SARIMA model provides a good balance between capturing seasonal trends and ensuring predictive accuracy.

```{r, sarima residuals, echo = FALSE, warning = F, fig.dim = c(7,4)}
# Check residuals of the SARIMA model
checkresiduals(sarima_model)
```

The SARIMA forecast visualization below provides an outlook for VRES energy production over the next two years, continuing from the historical data. The forecast shows a continuation of the established seasonal patterns, with recurring peaks and troughs that align with the cyclical nature of renewable energy production. The forecasted values exhibit an expected upward trend in energy production, consistent with recent years, indicating a gradual increase in VRES generation. The shaded area around the forecast line represents the prediction intervals, with wider bands toward the end of the forecast horizon, reflecting increased uncertainty as we look further into the future.

```{r, sarima plot, echo = FALSE, warning = F, cache = T, fig.dim = c(7,3)}
# Forecast the next years
sarima_forecast <- forecast(sarima_model, h = 730)

# Plot the forecast
#plot(sarima_forecast, main="SARIMA Forecast for VRES Time Series")

# Visualize the SARIMA forecast with confidence intervals
autoplot(sarima_forecast) +
  ggtitle("SARIMA Forecast for VRES Time Series") +
  xlab("Date") +
  ylab("Energy Production (GWh)")
```

## Analyisis of Daily Data of Day-Ahead Prices of Baseload
### Visualization of Day-Ahead Prices

We now would like to turn our attention to the baseload energy prices in EUR/MWh over time. From 2017 through most of 2021, prices remained relatively stable, fluctuating within a narrow range with occasional spikes. However, from the end of 2021 through 2023, there is a sharp and sustained increase in energy prices, with peaks exceeding 600 EUR/MWh and increased volatility. This surge is likely driven by exogenous factors, including the geopolitical tensions and market disruptions we previously identified. After mid-2023, prices gradually return to lower levels but still exhibit heightened volatility compared to pre-2021 levels. This period of extreme price fluctuations highlights the sensitivity of energy markets to external shocks.

```{r, day-ahead baseload_plot of day-ahead, echo = FALSE, warning = F, fig.dim = c(7,3)}
# Create a line plot of Baseload_EUR_MWh over time
ggplot(d.d, aes(x = as.Date(Date), y = Baseload_EUR_MWh)) +
  geom_line(color = "darkblue", size = 0.5) +
  labs(title = "Baseload Energy Prices Over Time",
       x = NULL, 
       y = "Baseload (EUR/MWh)") +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y",
               limits = c(as.Date("2017-01-01"), as.Date("2024-11-30"))) +
  theme_minimal() +
  theme(legend.title = element_blank(),  # Hide the legend title
  plot.title = element_text(hjust = 0.5),
  plot.title.position = "plot")
```

### Decomposition of Day-Ahead Prices

The observed panel of the below decomposition of the baseload energy prices shows the original data with significant spikes in prices from late 2021 through 2023, assumed to correspond to external market shocks. The trend component highlights a clear upward shift during this period, reflecting the sustained increase in energy prices caused by exogenous factors, followed by a gradual decline post-2023. The seasonal component exhibits recurring cyclical patterns, suggesting that energy prices also follow a predictable annual cycle, likely tied to demand patterns or seasonal energy production fluctuations. Lastly, the random component captures residual volatility, with pronounced variability during the price spikes in 2022 and 2023, indicating the presence of irregular shocks not explained by the trend or seasonality. 

```{r, day-ahead baseload_decomposition,  echo = FALSE, warning = F, fig.dim = c(7,4)}
# Convert the Baseload_EUR_MWh column to a time series object
# Assuming daily data, we set frequency = 365 for yearly seasonality
baseload_ts <- ts(d.d$Baseload_EUR_MWh, start = c(2017, 1), frequency = 365)

# Decompose the time series into trend, seasonal, and random components
decomp_baseload <- decompose(baseload_ts)

# Plot the decomposition
plot(decomp_baseload,
     xlab = "Time", 
     cex.lab = 0.8, oma=c(2.5,2.5,2,1), mar = c(0.1,6,0.2,0.2), 
     cex.axis = 0.8, las = 1, cex.main = 0.85)
title(main = "Decomposition of additive time series", cex.main = 0.9,
      line = 3.2)
```

### Stationarity of Day-Ahead Prices

```{r, day-ahead baseload_differencing 1, echo = FALSE, warning = F}
# # Apply first-order differencing to remove the trend
# diff_baseload_ts <- diff(baseload_ts, differences = 1)
# 
# # Plot the differenced series
# plot(diff_baseload_ts, main="Differenced Baseload Time Series")
# 
# # Apply seasonal differencing (assuming yearly seasonality with a frequency of 365)
# seasonal_diff_baseload_ts <- diff(diff_baseload_ts, lag = 365)
# 
# # Plot the seasonally differenced series
# plot(seasonal_diff_baseload_ts, main="Seasonally Differenced Baseload Time Series")

```

To stabilize the variance and remove the trend and seasonality in the time series, we apply a log-transformation, followed by first-order differencing to eliminate the linear trend and seasonal differencing to account for cyclical patterns in the data.

```{r, day-ahead baseload_differencing 2, echo = FALSE, warning = F, fig.dim = c(7,3)}
# Apply log transformation (add a small constant to avoid log(0) issues)
baseload_log_d <- log(baseload_ts + 1e-6)

# Apply first-order differencing to the log-transformed series
baseload_log_diff_d <- diff(baseload_log_d)

# Apply seasonal differencing
baseload_log_seasonal_diff_d <- diff(baseload_log_diff_d, lag = 365)
# sum(is.na(baseload_log_seasonal_diff_d))

# Save current par settings
old_par <- par(no.readonly = TRUE)

# Adjust graphical parameters
par(cex.lab = 0.8, cex.axis = 0.75, cex.main = 0.85)

plot(baseload_log_seasonal_diff_d, 
     main="Log-Transformed and Seasonally Differenced Baseload Time Series", 
     ylab = "Differenced EUR", 
     xlab = NULL)

# Reset to original par settings
par(old_par)
```

After the initial transformations, the time series still displays some spikes, which could be indicative of outliers (shown below). We employ the z-score method to identify and correct potential outliers. This approach detects extreme values by measuring how many standard deviations a data point is from the mean. However, while this step reduced some variability, the time series still showed variance inconsistency.

```{r, outlier_detection0, echo = T, warning = F}
# Calculate z-scores for the time series
z_scores <- (baseload_log_seasonal_diff_d - 
               mean(baseload_log_seasonal_diff_d, na.rm = TRUE)) /
                sd(baseload_log_seasonal_diff_d, na.rm = TRUE)

# Set a threshold for outlier detection (commonly 3 standard deviations)
outliers <- which(abs(z_scores) > 3)

# Print the indices of the detected outliers
print(outliers)
```


```{r, outlier_detection1, echo = FALSE, warning = F, fig.dim = c(7,3)}
# Replace outliers with NA or the median (imputation)
baseload_clean <- baseload_log_seasonal_diff_d
baseload_clean[outliers] <- NA  # Replacing with NA
baseload_clean <- na.approx(baseload_clean)  # Interpolating NA values

# Save current par settings
old_par <- par(no.readonly = TRUE)

# Adjust graphical parameters
par(cex.lab = 0.8, cex.axis = 0.75, cex.main = 0.85)

# Plot the cleaned time series
plot(baseload_clean, main="Cleaned Time Series After Z-Score Outlier Removal",
     xlab = NULL)

# Reset to original par settings
par(old_par)
```

Since the z-score approach does not fully address the variance issues, we turn to the Interquartile Range (IQR) method. The IQR approach is more robust for detecting outliers in time series with non-normal distributions, as it focuses on the middle 50% of the data. 

```{r, outlier_detection2, echo = FALSE, warning = F,  fig.dim = c(7,3)}
# Calculate the IQR
Q1 <- quantile(baseload_log_seasonal_diff_d, 0.25, na.rm = TRUE)
Q3 <- quantile(baseload_log_seasonal_diff_d, 0.75, na.rm = TRUE)
IQR_value <- IQR(baseload_log_seasonal_diff_d, na.rm = TRUE)

# Define lower and upper bounds for outliers
lower_bound <- Q1 - 1.5 * IQR_value
upper_bound <- Q3 + 1.5 * IQR_value

# Detect outliers
outliers <- which(baseload_log_seasonal_diff_d < lower_bound | baseload_log_seasonal_diff_d > upper_bound)

# Replace outliers with NA or the median (imputation)
baseload_clean <- baseload_log_seasonal_diff_d
baseload_clean[outliers] <- NA  # Replacing with NA
baseload_clean <- na.approx(baseload_clean)  # Interpolating NA values

# Save current par settings
old_par <- par(no.readonly = TRUE)

# Adjust graphical parameters
par(cex.lab = 0.8, cex.axis = 0.75, cex.main = 0.85)

# Plot the cleaned time series
plot(baseload_clean, main="Cleaned Time Series After IQR Outlier Removal",
     xlab = NULL)

# Reset to original par settings
par(old_par)
```

This method looks promising in identifying and treating the outliers, resulting in a more stable time series. We perform a decomposition of the time series after the IQR outlier removal to examine its components.

```{r, decomp_baseload_clean, echo = FALSE, warning = F, fig.dim = c(7,4)}
# Decompose the time series
decomp_baseload_clean <- decompose(baseload_clean)

# Plot the decomposition
plot(decomp_baseload_clean,
     xlab = "Time", 
     cex.lab = 0.8, oma=c(2.5,2.5,2,1), mar = c(0.1,6,0.2,0.2), 
     cex.axis = 0.8, las = 1, cex.main = 0.85)
title(main = "Decomposition of addtitive time series", cex.main = 0.9,
      line = 3.2)
```

The decomposition of the IQR approach of cleaning the time series still shows a trend. Hence, to address the remaining trend, we apply an additional round of differencing, hoping to remove the remaining trend.

```{r, 2_order_diff_bl, echo = FALSE, warning = F, fig.dim = c(7,3)}
# Apply second-order differencing
baseload_log_diff_second <- diff(baseload_clean)

# Save current par settings
old_par <- par(no.readonly = TRUE)

# Adjust graphical parameters
par(cex.lab = 0.8, cex.axis = 0.75, cex.main = 0.85)

# Plot the cleaned time series
plot(baseload_log_diff_second,
     main="Second-Order Differenced Baseload Time Series",
     xlab = NULL)

# Reset to original par settings
par(old_par)
```

Again, the differenced time series looks promising but we will decompose it to ensure stationarity.

```{r, decomp_baseload_clean_2, echo = FALSE, warning = F, fig.dim = c(7,4)}
# Decompose the time series
decomp_baseload_clean_2 <- decompose(baseload_log_diff_second)

# Plot the decomposition
plot(decomp_baseload_clean_2,
     xlab = "Time", 
     cex.lab = 0.8, oma=c(2.5,2.5,2,1), mar = c(0.1,6,0.2,0.2), 
     cex.axis = 0.8, las = 1, cex.main = 0.85)
title(main = "Decomposition of differenced time series", cex.main = 0.9,
      line = 3.2)
```

The decomposition of the differenced time series now looks stationary and to statistically verify stationarity, we conduct the ADF-test.

```{r, day-ahead baseload_adf, include = T, echo = FALSE, warning = F, }
# Perform ADF test to check stationarity
adf.test(baseload_log_diff_second)
```

The ADF-test returns a p-value less than 0.01, confirming that the time series is now stationary.

\newpage

### Model Specification of Day-Ahead Prices

```{r, acf_pacf_bl_sec1, echo = FALSE, warning = F, fig.dim = c(7,2.6)}
# Save current par settings
old_par <- par(no.readonly = TRUE)

# Adjust graphical parameters
par(cex.lab = 0.8, cex.axis = 0.75, cex.main = 0.85, mar = c(4,3.8,3,1))

# Plot ACF and PACF
acf(baseload_log_diff_second, lag.max = 1000, main="ACF of Stationary Series")

# Reset to original par settings
par(old_par)
```

```{r, acf_pacf_bl_sec2, echo = FALSE, warning = F, fig.dim = c(7,2.6)}
# Save current par settings
old_par <- par(no.readonly = TRUE)

# Adjust graphical parameters
par(cex.lab = 0.8, cex.axis = 0.75, cex.main = 0.85, mar = c(4,3.8,3,1))

# Plot PACF
pacf(baseload_log_diff_second, lag.max = 1000, main="PACF of Stationary Series")

# Reset to original par settings
par(old_par)
```

The ACF shows significant autocorrelation at various lags and the PACF exhibits various significant lags but is somewhat decaying. Specifically the slow decay in ACF may indicate that the series is not yet stationary, or it could be exhibiting long memory properties. Possible causes include under-differencing, remaining seasonality or long memory processes. Consulting the above decomposition of the second-order differenced time series, we suspect that there may still be some seasonal patterns in the differenced data, so we will further seasonally difference the the time series. 

```{r, diff_season_bl, echo = FALSE, warning = F, fig.dim = c(7,3.6)}
# Diff seasonality
baseload_log_diff_third <- diff(baseload_log_diff_second, lag = 365)

# Plot the decomposition
plot(decompose(baseload_log_diff_third),
     xlab = "Time", 
     cex.lab = 0.8, oma=c(2.5,2.5,2,1), mar = c(0.1,6,0.2,0.2), 
     cex.axis = 0.8, las = 1, cex.main = 0.85)
title(main = "Decomposition of additive time series", cex.main = 0.9,
      line = 3.2)
```


```{r, acf_pacf_bl_third, echo = FALSE, warning = F, fig.dim = c(7,2.6)}
# Save current par settings
old_par <- par(no.readonly = TRUE)

# Adjust graphical parameters
par(cex.lab = 0.8, cex.axis = 0.75, cex.main = 0.85, mar = c(4,3.8,3,1))

# Plot ACF and PACF
acf(baseload_log_diff_third, lag.max = 1000, main="ACF of Stationary Series")
pacf(baseload_log_diff_third, lag.max = 1000, main="PACF of Stationary Series")

# Reset to original par settings
par(old_par)
```

After further inspection of the ACF and PACF, the same problem still persist, limiting the next steps on analyzing the time series. For illustrative purposes, we will commence with the forecast of the baseload prices, using the second-order differenced time seriesn and higher order AR(3) and MA(2) terms, fully understanding that this may result in the model failing the Ljung-Box test.

```{r, arima_bl, echo = T, warning = F, cache = T}
model_baseload <- Arima(baseload_log_diff_second, order = c(3, 1, 2),
                        seasonal = list(order = c(0, 1, 0), period = 365))
summary(model_baseload)
```

```{r, residuals_bl, echo = FALSE, warning = F}
tsdisplay(residuals(model_baseload))
Box.test(residuals(model_baseload), lag = 20, type = "Ljung-Box")
```

As anticipated, the Ljung-Box test has a very low p-value which indicates that we have missed some structures in our time series. The plot below shows the forecast of the second-order differenced time series.

```{r, forecast_bl_1, echo = FALSE, warning = F, cache = T}
# Save current par settings
old_par <- par(no.readonly = TRUE)

# Adjust graphical parameters
par(cex.lab = 0.8, cex.axis = 0.75, cex.main = 0.85)

# Forecast the next period
arima_forecast_baseload <- forecast(model_baseload, h = 100)
plot(arima_forecast_baseload)

# Reset to original par settings
par(old_par)
```

If we were to continue the analysis, the next steps would involve reversing the transformations applied to achieve stationarity in order to interpret the forecasts on the original scale. This process includes integrating the forecasted values by  reversing the seasonal and non-seasonal differencing — using the last observed data points as starting values — and then applying the exponential function to undo the log-transformation. By doing so, we would obtain forecasted baseload values that are meaningful and comparable to the original data.

\newpage

# Conclusions, Limitations and Outlook
\subsection*{Conclusions}

The electricity consumption and production per type was studied in Switzerland with the focus on wind and solar power as Variable Renewable Energy Sources (VRES). The production of the VRES has been steadily growing in the past years, while displaying a clear pattern of seasonality dominated by the solar production.

We examined and explained the differences between positive and negative control energy, as well as secondary and tertiary control energy, to provide a deeper understanding of their impact on grid stability and cost fluctuations.

The cost of control energy was analyzed using the data provided by Swissgrid. The analysis of the yearly costs showed a rise in costs after the year 2020. This period also showed larger variance in the hourly costs of control energy.

The Vector Autoregression analysed in Chapter 5.3 indicates a causal relationship between VRES and hourly control energy costs with VRES lags influencing control costs. This relationship is confirmed by the Granger test, indicating that lags of VRES variability Granger-causes control costs.

We expect increasing VRES production as indicated by the SARIMA model of daily VRES production, as well as increasing volatility and higher peaks of day-ahead electricity prices.

\subsection*{Limitations}

The models used in the analysis do not fully account for external shocks like geopolitical events (e.g., the war in Ukraine), which can introduce noise and volatility. The accuracy of the VAR model is sensitive to lag length selection, which could miss shorter or longer-term effects;

Even after applying second-order differencing of the day-ahead prices, we anticipated that the model might still face challenges such as failing the Ljung-Box test due to remaining structures in the time series. Next steps of the day-ahead price analysis would involve reversing the transformations (seasonal and non-seasonal differencing, and log transformation) to interpret the forecast in its original scale.

The complexity of the system, as described in Chapter 2.2, constitutes a big challenge in the analysis of interactions within the system of energy production. There are many external factors that influence the electricity and control energy prices. This showed very pronounced in the analysis of the day-ahead electricity prices performed in Chapter\ 5.5. 

A limitation when looking at the control energy costs is the focus on the activated control energy. This is only part of the cost for Swissgrid and therefore the end-consumer. Another part is the cost for the capacity provision. While no raw data was found for this cost, the yearly numbers are published in an annual report from the Federal Electricity Commission[^ELCOM-R-2022]. The cost for provisioning vary from approximately 50 - 200 Mio CHF from 2015 to 2021 with a sharp increase to almost 500 Mio CHF in 2022, exceeding the costs for the activation analyzed in this report.

A factor not considered in this report is the changes in the procurement procedure for control energy and the effects on the prices[^Procurement]. The addition of direction-specific products since 2018 for example allows for a larger number of producers / consumers to offer their services.

\newpage
Another significant influence on prices is regulations and international collaboration. In recent years, the collaboration for optimal use of control energy has increased, exemplified by projects such as PICASSO, MARI, and TERRE.[^Swissgrid-projects]. These projects focus, among other things, on implementing platforms for tendering control energy and coordinating the activation of control energy.[^Terre] Switzerland's participation in these international efforts is beneficial and crucial for maintaining grid stability. However, this participation might be challenging to sustain if relations between the EU and Switzerland continue to deteriorate.[^Elcom-taet2023] 
The implementation of these projects and their impact on control energy costs have not been included in the analysis conducted in this project.

[^ELCOM-R-2022]: https://www.elcom.admin.ch/dam/elcom/de/dokumente/2023/berichtregelleistungundregelenergie2022.pdf.download.pdf/Bericht%20Regelleistung%20und%20Regelenergie.pdf
[^Procurement]: https://www.youtube.com/watch?v=KYGUG217PYY
[^Swissgrid-projects]: https://www.swissgrid.ch/dam/swissgrid/about-us/newsroom/positions/210421-Factsheet-TERRE-en.pdf
[^Terre]: https://www.entsoe.eu/network_codes/eb/terre/
[^Elcom-taet2023]: https://www.elcom.admin.ch/dam/elcom/de/dokumente/2024/taetigkeitsbericht2023.pdf.download.pdf/Taetigkeitsbericht_ElCom_2023-DE_Einzelseiten.pdf

\subsection*{Outlook}

The limitations described in the previous section highlight starting points for further analysis of control energy costs and the influence of the addition of variable energy production.

While this report focuses on Switzerland, it is important to note that the electricity market in Europe is highly interdependent. Considering data from neighboring countries and cross-border transfers could provide additional insights and improve predictions regarding control energy costs.

A closer collaboration with stakeholders, such as Swissgrid, could be highly beneficial for continuing this analysis. They could provide additional data sources and offer insights into the effects of external factors. Furthermore, they could help refine the research questions to ensure that the results obtained from the analysis are valuable to them.

\newpage

# Biblioghraphy
