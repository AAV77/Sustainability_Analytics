---
title: "Evaluation of Variable Renewable Energy Source's contribution to cost of control energy"
author: "Del Conte, KÃ¼ng, van Lengerich, Vayloyan "
date: "2024-08-03"
output:
  pdf_document:
    toc: yes
bibliography: references.bib
editor_options: 
  chunk_output_type: console
notes: footnotes
---

```{r, include = F, warning = F}
library(readxl) #install packages first if not done so already
library(readr)
library(tidyr)
library(tidyquant)
library(lubridate)
library(ggplot2)
library(forecast)
library(tseries)
library(rugarch)
library(vars)
library(scales)
library(dplyr)

setwd(dirname(rstudioapi::getSourceEditorContext()$path)) #setting directory
```

```{r, importing power prices, warning = F, include= F, cache= T}
sheets_after_2015 <- c("EnergieUebersichtCH-2015.xls",
                       "EnergieUebersichtCH-2016.xls", 
                       "EnergieUebersichtCH-2017.xls",
                       "EnergieUebersichtCH-2018.xls", 
                       "EnergieUebersichtCH-2019.xls",
                       "EnergieUebersichtCH-2020.xls"
                       )

sheets_after_2021 <- c("EnergieUebersichtCH-2021.xlsx",
                       "EnergieUebersichtCH-2022.xlsx",
                       "EnergieUebersichtCH-2023.xlsx",
                       "EnergieUebersichtCH-2024.xlsx"
                       )

# Empty list to store data frames
data_list <- list()

# Loop through the sheets and read each one for xls
for (s in sheets_after_2015) {
  # Read the Excel file
  df <- read_xls(s, sheet = "Zeitreihen0h15",)
  df <- df %>% select (1, 7,8,9,10, 22:25) 
  
  # Convert the timestamp column
  df[[1]] <- as.numeric(df[[1]])
  df$Timestamp <- as.POSIXct(df[[1]] * 86400, origin = "1899-12-29 23:00:00", tz = "Europe/Zurich")
  
  # Store the data frame in the list
  data_list[[s]] <- df %>% select(-1)
}

# Loop through the sheets and read each one for xlsx
for (s in sheets_after_2021) {
  # Read the Excel file
  df <- read_xlsx(s, sheet = "Zeitreihen0h15",)
  df <- df %>% select (1, 7,8,9,10, 22:25) 
  
  # Convert the timestamp column
  df$Timestamp <- as.POSIXct(df[[1]], format = "%d.%m.%Y %H:%M", tz = "Europe/Zurich")
  
  #remove first column
  df <- df %>% select(-1)
  
  # Set the column-names to match the xls data
  # Adjusting the slightly different spelling
  colnames(df) <- 
    colnames(data_list[["EnergieUebersichtCH-2015.xls"]])
  
  # Store the data frame in the list
  data_list[[s]] <- df
}

# Combine all data frames in the list into one
combined_data <- bind_rows(data_list)

combined_data <- combined_data %>% 
  filter(combined_data[[2]] != "kWh") # taking out the duplicated headers which
                                      # ended up in the dataframe
```

```{r, manipulations 1, warning = F, include= F, cache= T}
combined_data <- combined_data %>% 
  rename(
    pos_sec_amount_kwh = names(combined_data)[1], 
    neg_sec_amount_kwh = names(combined_data)[2],
    pos_ter_amount_kwh = names(combined_data)[3],
    neg_ter_amount_kwh = names(combined_data)[4],
    price_pos_sec_EUR_MWh = names(combined_data)[5],
    price_neg_sec_EUR_MWh = names(combined_data)[6],
    price_pos_ter_EUR_MWh = names(combined_data)[7],
    price_neg_ter_EUR_MWh = names(combined_data)[8]
    ) 

combined_data <- combined_data %>% 
    mutate(across(c(1:8), as.numeric)) # convert to numeric

combined_data <- combined_data %>% 
  mutate( #calculating costs of energy
  cost_pos_sec = (combined_data[[1]] / 1000)*combined_data[[5]], 
  cost_neg_sec = (combined_data[[2]] / 1000)*combined_data[[6]],  
  cost_pos_ter = (combined_data[[3]] / 1000)*combined_data[[7]],
  cost_neg_ter = (combined_data[[4]] / 1000)*combined_data[[8]]
  ) %>% 
  select(9, everything())  #rearranging
```

```{r, Test combined data 2021 with report, warning = F, include= F}
sums_2021 <- combined_data %>%
    filter(year(Timestamp) == 2021) %>%
    summarise(across(where(is.numeric), ~ sum(.x, na.rm = FALSE)))
```

```{r, manipulations 2, warning = F, include= F, cache= T}
hourly_summary <- combined_data %>%
  mutate(hour = floor_date(Timestamp, "hour")) %>%  # Create a new column 'hour' 
                                                    # by rounding down to the 
                                                    # nearest hour
  group_by(hour) %>%  # Group by the new 'hour' column
  summarise(
    # Sum the energy amount columns
    pos_sec_amount_kwh = sum(pos_sec_amount_kwh, na.rm = TRUE),
    neg_sec_amount_kwh = sum(neg_sec_amount_kwh, na.rm = TRUE),
    pos_ter_amount_kwh = sum(pos_ter_amount_kwh, na.rm = TRUE),
    neg_ter_amount_kwh = sum(neg_ter_amount_kwh, na.rm = TRUE),

    # Sum the cost columns
    cost_pos_sec = sum(cost_pos_sec, na.rm = TRUE),
    cost_neg_sec = sum(cost_neg_sec, na.rm = TRUE),
    cost_pos_ter = sum(cost_pos_ter, na.rm = TRUE),
    cost_neg_ter = sum(cost_neg_ter, na.rm = TRUE),

    # Average the price columns
    avg_price_pos_sec_EUR_MWh = mean(price_pos_sec_EUR_MWh, na.rm = TRUE),
    avg_price_neg_sec_EUR_MWh = mean(price_neg_sec_EUR_MWh, na.rm = TRUE),
    avg_price_pos_ter_EUR_MWh = mean(price_pos_ter_EUR_MWh, na.rm = TRUE),
    avg_price_neg_ter_EUR_MWh = mean(price_neg_ter_EUR_MWh, na.rm = TRUE)
  ) %>%
  ungroup() %>%   # Ungroup to complete the operation
  rename(
  Timestamp    = hour #renaming for merging
  )
```

```{r, Test hourly summary, warning = F, include= F}
sums_2020 <- hourly_summary %>%
    filter(year(Timestamp) == 2020) %>%
    summarise(across(where(is.numeric), ~ sum(.x, na.rm = FALSE)))
```

```{r, importing renwable share, include = F , warning = F, include= F}
ren_gen <- read.csv("Generation_CH_2015-20.csv",header = T)
ren_gen <- ren_gen %>% select(-1) %>%   
  mutate(
    Timestamp= ymd_hms(cet_cest_timestamp, tz = "Europe/Zurich")) %>%   
  mutate(
    VRES_percent = (CH_solar_generation_actual+CH_wind_onshore_generation_actual)/CH_load_actual_entsoe_transparency)
#importing data and looking at the percentage of VRES generated hourly

```

```{r, join, include= F, warning = F }
d <- left_join(hourly_summary, ren_gen, by = "Timestamp") 
# merging on the hour

```

```{r, Test d, warning = F, include= F}
sums_2020 <- d %>%
    filter(year(Timestamp) == 2020) %>%
    summarise(across(where(is.numeric), ~ sum(.x, na.rm = TRUE)))
```

```{r, adding total cost, include = F, warning = F  }
d <- d %>% 
  #calculating total cost by summing all costs
  mutate(total_cost_EUR = cost_pos_sec+cost_neg_sec+cost_pos_ter+cost_neg_ter) %>% 
  #removing NA rows for total cost and VRES %, mainly later half 2020
  filter(!is.na(VRES_percent) | !is.na(total_cost_EUR)) %>% 
  select(-cet_cest_timestamp) %>%  # removing duplicate row, comment out this command
                                  # to show that the times are the same
  select(Timestamp, VRES_percent, total_cost_EUR, everything())
  
# remove(combined_data, data_list, df, hourly_summary, ren_gen)
# removing clutter
```

```{r, Test d, warning = F, include= F}
sums_2020 <- d %>%
    filter(year(Timestamp) == 2020) %>%
    summarise(across(where(is.numeric), ~ sum(.x, na.rm = FALSE)))
```

```{r, adding units where missing, include = F, warning = F}
d.h <- d %>%
  rename(
    cost_pos_sec_EUR = cost_pos_sec, 
    cost_neg_sec_EUR = cost_neg_sec,
    cost_pos_ter_EUR = cost_pos_ter,
    cost_neg_ter_EUR = cost_neg_ter,
    CH_load_actual_entsoe_transparency_MW = CH_load_actual_entsoe_transparency,
    CH_load_forecast_entsoe_transparency_MW = CH_load_forecast_entsoe_transparency,
    CH_solar_capacity_MW = CH_solar_capacity,
    CH_solar_generation_actual_MW = CH_solar_generation_actual,
    CH_wind_onshore_capacity_MW = CH_wind_onshore_capacity,
    CH_wind_onshore_generation_actual_MW = CH_wind_onshore_generation_actual,
    ) 
  
```

```{r, add benchmark data, include = F, warning = F}
# Load the datasets
energy_production <- read_csv("ogd104_stromproduktion_swissgrid.csv")
energy_prices <- read_csv("ogd106_preise_strom_boerse.csv")

# Reshape the energy production data to have one column per energy source
energy_production <- energy_production %>%
  pivot_wider(names_from = Energietraeger, values_from = Produktion_GWh, values_fill = 0)

# Merge the reshaped energy production data with the energy prices data
d.d <- merge(energy_prices, energy_production, by="Datum", all.x=TRUE)

# Fill any remaining NAs with 0 (in case there were dates in energy_prices not in energy_production)
d.d[is.na(d.d)] <- 0
```

```{r, rename variables, include = F, warning = F}

# Rename columns in dataset
d.d <- d.d %>%
  rename(
    Date = Datum,
    Hydro_GWh = Flusskraft,
    Nuclear_GWh = Kernkraft,
    Storage_GWh = Speicherkraft,
    Thermal_GWh = Thermische,
    Photovoltaic_GWh = Photovoltaik,
    Wind_GWh = Wind
  )
```

```{r, add vres and non-vres, include = F, warning = F}

# Add new columns 'VRES_GWh' and 'Non_VRES_GWh' to d.d
d.d <- d.d %>%
  mutate(
    VRES_GWh = Photovoltaic_GWh + Wind_GWh,
    Non_VRES_GWh = Hydro_GWh + Nuclear_GWh + Storage_GWh + Thermal_GWh
  )

# View the first few rows to confirm the new columns
head(d.d)
```

```{r, rename variables, include = F, warning = F}
# Remove clutter
remove(energy_production, energy_prices)
```

```{r, Test d.h, warning = F, include= F}
sums_2019 <- d.h %>%
    filter(year(Timestamp) == 2019) %>%
    summarise(across(where(is.numeric), ~ sum(.x, na.rm = FALSE)))

sums_2020 <- d.h %>%
    filter(year(Timestamp) == 2020) %>%
    summarise(across(where(is.numeric), ~ sum(.x, na.rm = FALSE)))

sums_2021 <- d.h %>%
    filter(year(Timestamp) == 2021) %>%
    summarise(across(where(is.numeric), ~ sum(.x, na.rm = FALSE)))
```

\newpage

# Introduction

Governments and scientists around the world largely agree on the need for a low-carbon electricity production. In the Sustainable Development Goal 7 (affordable and clean energy)[\^sdg]. A step in this direction is the construction, installation and connection of Renewable Energy Sources (RES) such as Hydropower, Wind and Solar to the electricity grid. These produce little to no direct emissions while supplying electricity and have life cycle carbon costs far lower than fossil fuels (@LCElectricity). A substrate of RES are so called Variable-RES (VRES), which are electricity sources whose production cannot easily be increased or decreased by the operator. Wind and Solar both rely on meteorological conditions, if these are not right, nothing is produced. This is contrary to most other sources whose production can be increased or decreased according to market needs. Although the time it takes to ramp production up or down can still present a challenge. [\^sdg]: <https://sdgs.un.org/goals>

The lack of direct control over production with VRES presents a huge challenge to the adoption of such sources, since there is no large scale energy storage available. Battery Storage, Pumped Hydro and Heat Pumps do store energy, but currently these forms of power would not be able to power a country for even a couple of hours.

The addition of electricity from VRES has the possibility to:

1.  Drastically lower electricity prices.
2.  Increase price volatility.
3.  Rapidly change the quantity of electricity available on the grid in either direction.

The reason for the first claim is that VRES has practically no marginal costs. No fuel rods, pumping, gas or other notable inputs are required to produce solar and wind energy. This means producers of VRES will bid their energy at almost any price. If they cannot profit - maximize, they will loss - minimize.

The second claim is the case because meteorological events tend to be fairly consistent across an area. When one wind / solar farm is producing, so are the ones around it. This means there is huge downward pressure on prices during periods of favorable VRES production and none at all during unfavorable conditions.

The third claim is particularly relevant for control energy's price. The reason for this is described in the next two points.

## Control Energy

One aspect of electricity prices is the price paid for control energy. This is the short term (up to 15 min) electricity supply used to keep the grid at a constant frequency, due to unforeseen changes in supply and demand. It is necessary since the amount of energy consumed and produced must always be identical. The increased penetration of VRES, which cannot be steered by operators means that the purchase of such energy should be increasing with more VRES installed on the grid in recent years.

## Relevance

If the amount of control electricity purchased by Transmission System Operators increases then this means costs will be passed down to consumers. Since electricity is a primary input in the economy, higher prices will be reflected across the vast majority of goods and services. This is an undesirable outcome. It is therefore important for policymakers, stakeholder and the public to understand the drivers of increased prices of control energy. This is particularly important in the context of the SDG 7, which stresses the need for clean energy. Policymakers must understand the impact of increasing the share of VRES on the grid to be aware of potential economic and political backlash of their decisions.

## Literature Review

The academic literature on VRES's effect on control energy is fairly sparse. Using the search terms "control energy" and "(variable) renewable energy", only one relevant paper was found. @hirth_control_2013 have found that the inclusion of VRES from 2008-2013 decreases procurement cost of control power by 50%, presumably permitting lower prices for end consumers. The broader literature on the effect of VRES on electricity supply is broader.

These areas generally focus on both variability of supply and prices. Amongst them: @pereiradasilva2019 who use EGARCH time series and regression while studying the Iberian power market; @frauendorfer2018 who find that the Swiss are "importing" lower German power prices during peak solar production, as Germany has much more solar energy sources than the Swiss. Finally, the authors @dong2019 find that the Swedish have more stable prices due to the relativley high proportion of non variable fossil and hydropower than the Danes, who are more reliant on VRES in the form of wind and solar. Other studies in the area are more conflicted, such as @rintamÃ¤ki2017 who compare Germany and Danish prices and wind that the effect of increasing wind production on day ahead prices is not constant. The point is that increasing VRES leads to variability in supply, which presumably means more cost for balancing out an unpredictable supply when the predictions are wrong.

It is the purpose of this study to see whether and if so, to what extent renewable energy sources are related to increasing costs of control energy.

## Data Sources

### Electricity Prices

Swissgrid provides data on 15-minute electricity prices, divided into secondary and tertiary.

Access: <https://www.swissgrid.ch/en/home/operation/grid-data/generation.html>

### Generation Share Wind and Solar

Open Data on VRES Production in Europe, including Switzerland.

Access: <https://data.open-power-system-data.org/time_series>

# Exploratory Data Analysis (EDA)

VRES don't account for a lot of Energy

```{r Wind and Solar, include = TRUE, echo = FALSE}
# Filter the dataset to include only data up to the year 2020 (As for those Data only till 2020 are available)
d.h_upto2020 <- d.h %>%
  filter(Timestamp <= as.Date("2020-12-31"))  

# Plot the filtered data with wind in the foreground and solar in the background
ggplot(d.h_upto2020) + 
  # Solar generation in the background
  geom_line(aes(x = Timestamp, y = CH_solar_generation_actual_MW, color = "Solar"), size = 1) + 
  # Wind generation in the foreground
  geom_line(aes(x = Timestamp, y = CH_wind_onshore_generation_actual_MW, color = "Wind"), size = 1) + 
  ggtitle("Wind and Solar Generation over Time") +
  xlab("Time") +
  ylab("Generation (MW)") +
  scale_color_manual(values = c("Wind" = "blue", "Solar" = "orange")) + 
  theme_minimal() +
  labs(color = "Generation Type")


#Moving Average
# Plot the filtered data with wind in the foreground and solar in the background
ggplot(d.h_upto2020) + 
  # Solar generation in the background
  geom_ma(ma_fun= SMA, n = 24, aes(x = Timestamp, y = CH_solar_generation_actual_MW, color = "Solar"), size = 1) +

# Wind generation in the foreground
  geom_ma(ma_fun= SMA, n = 24, aes(x = Timestamp, y = CH_wind_onshore_generation_actual_MW, color = "Wind"), size = 1) + 
  ggtitle("Wind and Solar Generation Moving Average over Time") +
  xlab("Time") +
  ylab("Generation (MW)") +
  scale_color_manual(values = c("Wind" = "blue", "Solar" = "orange")) + 
  theme_minimal() +
  labs(color = "Generation Type")


  
```

```{r VRES, include = TRUE, echo = FALSE}


# VRES_percent Range

min_VRES <- min(d.h$VRES_percent, na.rm = TRUE)
max_VRES <- max(d.h$VRES_percent, na.rm = TRUE)

min_VRES
max_VRES



# Plot the filtered data
ggplot(d.h_upto2020, aes(x = Timestamp, y = VRES_percent * 100)) + 
  geom_line(color = "blue") + 
  ggtitle("VRES Percent over Time") +
  xlab("Time") +
  ylab("VRES percent [%]") +
  scale_y_continuous(labels = scales::label_number(suffix = "%")) + 
  theme_minimal()

# Moving Average
ggplot(d.h_upto2020)+ 
  geom_ma(ma_fun= SMA, n = 24, aes(x = Timestamp, y = VRES_percent* 100)) + 
  ggtitle("VRES_percent Over Time (Up to 2020)") +
  xlab("Time") +
  ylab("VRES percent [%]") +
  scale_y_continuous(labels = scales::label_number(suffix = "%")) + 
  theme_minimal()
```

The above graph displays VRES_percent (Variable Renewable Energy Sources as a percentage of total energy demand) over time. The graph exhibits a cyclical wave pattern, indicating the presence of seasonality, which is expected due to the seasonal nature of wind and solar energy production. This seasonality reflects the fluctuations in renewable energy availability throughout the year.

Toward the end of the graph, there's a noticeable spike or "bump," where the VRES_percent doubles the usual peak levels observed earlier. However, even with this significant increase, the maximum VRES_percent only reaches 0.27% of the total energy demand. This suggests that despite the seasonal variations and occasional spikes, the contribution of renewable energy remains relatively small in the overall energy mix

```{r, Cost of Secondary Control Energy, include = TRUE}


# Cost aggregated by Year

# Convert the 'Timestamp' column to POSIXct format
d.h$Timestamp <- as.POSIXct(d.h$Timestamp, format = "%Y-%m-%d %H:%M:%S")

# Extract the year from the 'Timestamp' column
d.h$year <- year(d.h$Timestamp)

# Group by 'year' and summarize the total cost for each year
df_yearly_cost <- d.h %>%
  group_by(year) %>%
  summarise(total_cost = sum(cost_neg_sec_EUR, na.rm = TRUE))


# Filter out the year 2024 and group by 'year', then summarize the total cost for each year
df_yearly_cost <- d.h %>%
  filter(year != 2024) %>%  # Exclude the year 2024
  group_by(year) %>%
  summarise(total_cost = sum(cost_neg_sec_EUR, na.rm = TRUE)) #y-axis with 'Mio' and commas

# Reshape the data into long format, selecting all four relevant columns
d.h_long <- d.h %>%
  filter(year != 2024) %>%  # Exclude the year 2024
  pivot_longer(cols = c(cost_pos_sec_EUR, cost_neg_sec_EUR, cost_pos_ter_EUR, cost_neg_ter_EUR), 
               names_to = "cost_type", values_to = "cost_value")

# Group by 'year' and 'cost_type', then summarize the total cost for each
df_yearly_cost <- d.h_long %>%
  group_by(year, cost_type) %>%
  summarise(total_cost = sum(cost_value, na.rm = TRUE)) %>%
  ungroup()

# Create a bar plot for the sum of costs per year, with different colors for each 'cost_type'
ggplot(df_yearly_cost, aes(x = as.factor(year), y = total_cost / 1e6, fill = cost_type)) +  # Y-axis in millions
  geom_bar(stat = "identity", position = "dodge", color = "black") +  # Dodge to separate the bars
  ggtitle("Total Costs of Secondary and Tertiary Control Energy per Year in EUR") +
  xlab("Year") +
  ylab("Total Cost (Million EUR)") +
  scale_y_continuous(labels = label_number(suffix = " Mio", big.mark = ",")) +  # Format y-axis

  # Use the correct order of colors and labels according to the levels of cost_type
  scale_fill_manual(values = c("skyblue2", "lightblue1", "gold", "yellow"), 
                    breaks = c("cost_pos_sec_EUR", "cost_neg_sec_EUR", "cost_pos_ter_EUR", "cost_neg_ter_EUR"),
                    labels = c("Pos. Sec.", "Neg. Sec.", "Pos. Ter.", "Neg. Ter.")) +  # Custom colors and labels

  theme_minimal() +
  theme(legend.title = element_blank())  # Hide the legend title

# Identify exact duplicate rows
duplicate_rows <- d.h[duplicated(d.h) | duplicated(d.h, fromLast = TRUE), ]
duplicate_rows

```

The above plot visualizes the total yearly costs in Euro of secondary and tertiary control energy (positive and negative) from 2015 to 2023. The plot highlights trends in the costs associated with these control energy types, it is clearly visible that these total costs have risen in the last years.

```{r Wind and Solar, include = TRUE, echo = FALSE}

# Histogram for CH_solar_generation_actual
ggplot(d, aes(x = CH_solar_generation_actual)) + 
  geom_histogram(binwidth = 10, fill = "red", color = "black") +
  scale_y_log10()
  ggtitle("Histogram of CH_solar_generation_actual")


```

## Time Series of Hourly Data (TO BE ADJUSTED)

\<\<<descriptions and interpretations to be added later>\>\>

\<\<\<\<\<\<\< HEAD \### Total Cost of Control Energy

### 1. Visualization of Control Costs

```{r, vres ts prep, include = FALSE, warning = F}
# Convert the Timestamp column to a Date-Time object
d$Timestamp <- as.POSIXct(d$Timestamp, format="%Y-%m-%d %H:%M:%S")

# Replace NAs in 'VRES_percent' with zero
d$VRES_percent[is.na(d$VRES_percent)] <- 0

# Convert VRES_percent into a time series object
VRES_ts <- ts(d$VRES_percent, start=c(2015, 1), frequency=24*365.25)  # Assuming hourly data
```

```{r, plot ts of vres percent, echo = FALSE, warning = F}

# Create the plot for VRES_percent with a linear trend line
ggplot(d.h, aes(x = as.Date(Timestamp), y = total_cost_EUR)) +
  geom_line(color = "darkblue") +                     
  geom_smooth(method = "lm", color = "black", se = FALSE) +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  labs(title = "Cost of Control Energy Over Time",
       x = NULL, 
       y = "Cost in EUR per kWh")
```

### 2. Decomposition of Control Costs

```{r, costs ts prep, include = FALSE, warning = F}
# Convert the Timestamp column to a Date-Time object
d.h$Timestamp <- as.POSIXct(d.h$Timestamp, format="%Y-%m-%d %H:%M:%S")

# Replace NAs in 'total_cost_EUR' with zero
d.h$total_cost_EUR[is.na(d.h$total_cost_EUR)] <- 0

# Convert total_cost_EUR into a time series object
total_cost_EUR_ts <- ts(d.h$total_cost_EUR, start = c(2015, 1), end = c(2020, 8), frequency=24*365.25)
```

```{r, costs additive decomposition, echo = FALSE, warning = F}

# Decompose the time series
cost_decomposed <- decompose(total_cost_EUR_ts)
plot(cost_decomposed)
```

### 3. Stationarity of Control Costs

```{r, differencing of day-ahead, echo = FALSE, warning = F}

# Apply log transformation (add a small constant to avoid log(0) issues)
costs_log <- log(total_cost_EUR_ts + 1e-6)

# Apply first-order differencing to remove the trend
costs_log_diff <- diff(costs_log, differences = 1)
sum(is.na(costs_log_diff))
costs_log_diff <- na.approx(costs_log_diff)
sum(is.na(costs_log_diff))

# Plot the differenced series
plot(costs_log_diff, main="Differenced Total Costs Time Series")

# Apply seasonal differencing (assuming yearly seasonality with a frequency of 365)
costs_log_diff_seasonal <- diff(costs_log_diff, lag = 365)

# Plot the seasonally differenced series
plot(costs_log_diff_seasonal, main="Seasonally Differenced Total Costs Time Series")

```

### VRES of Control Energy

### 1. Visualization of VRES Control Energy

```{r, plot ts of vres percent, echo = FALSE, warning = F}

# Create the plot for VRES_percent with a linear trend line
ggplot(d.h %>%
         filter(as.Date(Timestamp) <= as.Date("2020-08-31")), 
       aes(x = as.Date(Timestamp), y = VRES_percent)) +
  geom_line(color = "darkgreen") +                     # Line plot of VRES_percent
  geom_smooth(method = "lm", color = "black", se = FALSE) +  # Add linear trend line
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  labs(title = "VRES Percentage Over Time",
       x = NULL, 
       y = "VRES Percent")
```

### 2. Decomposition of VRES Control Energy

```{r, vres ts prep, include = FALSE, warning = F}
# Convert the Timestamp column to a Date-Time object
d.h$Timestamp <- as.POSIXct(d.h$Timestamp, format="%Y-%m-%d %H:%M:%S")

# Replace NAs in 'VRES_percent' with zero
d.h$VRES_percent[is.na(d.h$VRES_percent)] <- 0

# Convert VRES_percent into a time series object
VRES_ts <- ts(d.h$VRES_percent, start = c(2015, 1), end = c(2020, 8), frequency=24*365.25)
```

```{r, vres additive decomposition, echo = FALSE, warning = F}

# Decompose the time series
VRES_decomposed <- decompose(VRES_ts)
plot(VRES_decomposed)
```

### 3. Stationarity of VRES Control Energy

```{r, vres adf1, echo = FALSE, warning = F}

# Perform Augmented Dickey-Fuller test
adf.test(VRES_ts)
```

The Augmented Dickey-Fuller test has a p-value of 0.01 although the decomposition clearly shows a trend, seasonality and also a change in randomness. We suspect a decomposition of a multiplicative time series might help. A multiplicative decomposition assumes that the components (trend, seasonality, and noise) interact in a multiplicative manner. This is often suitable when the variability of the series increases as the level of the series increases, which might be indicated by the trend and seasonal patterns scaling with the overall level.

Applying a log transformation to the data can stabilize the variance, which often makes the series more amenable to decomposition or modeling. The log transformation essentially converts a multiplicative relationship into an additive one.

```{r, vres multiplicative decomposition, echo = FALSE, warning = F}

# Apply log transformation (add a small constant to avoid log(0) issues)
VRES_log <- log(VRES_ts + 1e-6)

# Decompose the log-transformed time series
VRES_log_decomposed <- decompose(VRES_log)
plot(VRES_log_decomposed)

# Apply first-order differencing to the log-transformed series
VRES_log_diff <- diff(VRES_log)

# Plot the differenced series
plot(VRES_log_diff, main="Differenced Log-Transformed VRES Time Series")

# Apply seasonal differencing
VRES_log_seasonal_diff <- diff(VRES_log_diff, lag = 365)
sum(is.na(VRES_log_seasonal_diff))

# Plot the seasonally differenced log-transformed series
plot(VRES_log_seasonal_diff, main="Seasonally Differenced Log-Transformed VRES Time Series")

```

```{r, vres sarima, echo = FALSE, warning = F}

# Fit a SARIMA model using auto.arima
#sarima_model_h <- auto.arima(VRES_ts, seasonal = TRUE)

# Summary of the SARIMA model
#summary(sarima_model_h)

# Check residuals of the SARIMA model
#checkresiduals(sarima_model_h)

```

```{r, vres forecasting, echo = FALSE, warning = F}
# Forecast the next 365 periods (adjust as needed)
#sarima_forecast_h <- forecast(sarima_model_h, h = 365)

# Plot the forecast
#plot(sarima_forecast_h)

```

### 4. Vector Autoregression of VRES Impact on Total Control Costs

```{r, stationarity for var, echo = FALSE, warning = F}

adf.test(costs_log_diff_seasonal)
adf.test(VRES_log_seasonal_diff)
```

Determine the optimal lag length

```{r, lag length var, echo = FALSE, warning = F}
sum(is.na(costs_log_diff_seasonal))  # Check for NAs in costs_log_diff
sum(is.na(VRES_log_seasonal_diff))  # Check for NAs in VRES_log_seasonal_diff

VARselect(cbind(costs_log_diff_seasonal, VRES_log_seasonal_diff), lag.max = 10, type = "const")

```

```{r, var model, echo = FALSE, warning = F}
var_model <- VAR(cbind(costs_log_diff_seasonal, VRES_log_seasonal_diff), 
                 p = 10, type = "const")
summary(var_model)

```

```{r, granger, echo = FALSE, warning = F}
causality(var_model, cause = "VRES_log_seasonal_diff")

```

## Time Series of Daily Benchmark Data

### Daily VRES and non-VRES Production

#### 1. Visualization

```{r, sun and wind visualization, echo = FALSE, warning = F}

ggplot(d.d %>%
         select(Date, Photovoltaic_GWh, Wind_GWh) %>%
         pivot_longer(cols = c(Photovoltaic_GWh, Wind_GWh), 
                      names_to = "Source", 
                      values_to = "GWh"), 
       aes(x = as.Date(Date), y = GWh, color = Source)) +
  geom_line(size = 1) +
  labs(title = "Time Series of Photovoltaic and Wind Energy Production",
       x = NULL, y = "Energy Production (GWh)") +
  scale_color_manual(values = c("Photovoltaic_GWh" = "orange", "Wind_GWh" = "darkgrey")) +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y")
```

The first graph illustrates the evolution of photovoltaic and wind energy production over time. Photovoltaic production (in orange) exhibits a clear seasonal pattern, with higher output during the summer months and lower production in winter, reflecting the natural variation in solar energy availability. In contrast, Wind production (in grey) remains consistently low throughout the year with some fluctuations but no clear trend, indicating that wind energy may play a relatively small role in the overall energy production mix compared to photovoltaic energy.

```{r, vres visualization, echo = FALSE, warning = F}

ggplot(d.d %>%
         select(Date, VRES_GWh, Non_VRES_GWh) %>%
         pivot_longer(cols = c(VRES_GWh, Non_VRES_GWh), 
                      names_to = "Source", 
                      values_to = "GWh"), 
       aes(x = as.Date(Date), y = GWh, color = Source)) +
  geom_line(size = 1) +
  labs(title = "Time Series of VRES and Non-VRES Production",
       x = NULL, y = "Energy Production (GWh)") +
  scale_color_manual(values = c("VRES_GWh" = "darkgreen", "Non_VRES_GWh" = "black")) +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y")
```

The second graph compares VRES (Variable Renewable Energy Sources, including Photovoltaic and Wind) with Non-VRES (comprising Hydro, Nuclear, Storage, and Thermal energy). The Non-VRES sources (in black) dominate total energy production and display significant variability over time, driven by factors such as fluctuating demand and adjustments in non-renewable energy generation. VRES production (in green), while much lower in magnitude, shows a clear seasonal trend, largely driven by photovoltaic energy, with peaks in the summer months.

#### 2. Decomposition of Daily VRES Production

```{r, decomposition, echo = FALSE, warning = F}
# Create a time series object for VRES production (Photovoltaic + Wind)
vres_ts_d <- ts(d.d$VRES_GWh, start = c(2017, 1), frequency = 365)

# Decompose the VRES time series
vres_decomp_d <- decompose(vres_ts_d)
plot(vres_decomp_d, xlab = NULL)

# Check the first few values of each component
head(vres_decomp_d$trend)
head(vres_decomp_d$seasonal)
head(vres_decomp_d$random)
```

The decomposition reveals a clear linear trend and strong seasonal patterns, with some variability in both the seasonal component and residuals. While the seasonal noise is expected due to the nature of renewable energy sources like photovoltaic and wind, it does not obscure the overall pattern. The fluctuations in the residuals suggest potential volatility of variance, but this can be addressed by examining the residuals further after modeling.

#### 3. Stationarity of Daily VRES Production

First, we apply regular differencing to remove the linear trend and since there is seasonality, we also apply seasonal differencing.

```{r, differencing, echo = FALSE, warning = F}
# Apply log transformation (add a small constant to avoid log(0) issues)
vres_log_d <- log(vres_ts_d + 1e-6)

# Apply first-order differencing to the log-transformed series
vres_log_diff_d <- diff(vres_log_d)

# Apply seasonal differencing
vres_log_seasonal_diff_d <- diff(vres_log_diff_d, lag = 365)
sum(is.na(vres_log_seasonal_diff_d))

plot(vres_log_seasonal_diff_d, main="Log-Transformed and Seasonally Differenced VRES Time Series", 
     ylab = "Differenced GWh", 
     xlab = NULL)

```

```{r, vres stationarity, echo = FALSE, warning = F}
# Perform ADF test to check stationarity
adf.test(vres_log_seasonal_diff_d)
```

```{r, plot differencing, echo = FALSE, warning = F}
# # Set up the plot window to display two plots side by side
# par(mfrow = c(2, 1))
# 
# # Plot the differenced series
# plot(diff_vres_ts_d, main="Differenced VRES Time Series", 
#      ylab = "Differenced GWh", 
#      xlab = NULL)
# 
# # Plot the seasonally differenced series
# plot(seasonal_diff_vres_ts_d, main="Seasonally Differenced VRES Time Series", 
#      ylab = "Differenced GWh", 
#      xlab = NULL)
# 
# # Reset to the default single plot layout
# par(mfrow = c(1, 1))
```

The first plot (Differenced VRES Time Series) shows the series after first-order differencing. While the trend is largely removed, there still appears to be seasonal fluctuations in the data, suggesting that seasonal differencing may be necessary.The variance seems somewhat stable, but there is some volatility toward the latter half of the series.

The second plot (Seasonally Differenced VRES Time Series) shows the data after applying both first-order and seasonal differencing. The seasonality appears to be removed successfully. The variance still shows some volatility, particularly in the later years, but the overall pattern is more stable than the first-differenced series.

```{r, log-differencing, echo = FALSE, warning = F}
# # Apply log transformation to the original VRES series
# log_vres_ts_d <- diff(vres_ts_d)
# 
# # Apply differencing to the log-transformed series
# diff_log_vres_ts_d <- diff(log_vres_ts_d)
# seasonal_diff_log_vres_ts_d <- diff(diff_log_vres_ts_d, lag = 365)
# 
# # Plot the seasonally differenced log-transformed series
# plot(seasonal_diff_log_vres_ts_d, main="Seasonally Differenced Log-Transformed VRES Time Series", 
#      ylab="Log-Differenced GWh", 
#      xlab = NULL)

```

The log-transformation and seasonal differencing have not sufficiently stabilized the variance, this indicates that the series may still exhibit heteroscedasticity (i.e., non-constant variance) which is why we consider a GARCH model.

```{r warning=FALSE, vres garch, echo=FALSE}
# 
# # Specify the model for the mean
# spec <- ugarchspec(variance.model = list(model = "sGARCH", garchOrder = c(1, 1)),
#                    mean.model = list(armaOrder = c(1, 1)),
#                    distribution.model = "norm")
# 
# # Fit the GARCH model to the log-differenced series
# fit_garch <- ugarchfit(spec = spec, data = seasonal_diff_log_vres_ts_d)
# 
# # Summary of the fitted GARCH model
# summary(fit_garch)
# 
# # Plot the fitted volatility
# plot(fit_garch, which = 2)  # This will show the conditional variance (volatility)
# 
# # Forecast using the fitted GARCH model
# garch_forecast <- ugarchforecast(fit_garch, n.ahead = 365)
# 
# # Plot the forecasted volatility
# plot(garch_forecast, which = 1)  # Forecasted series
# plot(garch_forecast, which = 3)  # Forecasted conditional variance

```

#### 4. Forecast of Daily VRES Production

Let's resume with the ACF and PACF since the GARCH model does not yield the desired result.

```{r, acf pacf, echo = FALSE, warning = F}
# ACF and PACF for the log-transformed differenced series
acf(vres_log_seasonal_diff_d)
pacf(vres_log_seasonal_diff_d)
```

```{r, acf pacf, echo = FALSE, warning = F}

# Fit a SARIMA model with auto.arima to handle seasonality
sarima_model <- auto.arima(vres_ts_d, seasonal = TRUE)

# Summary of the fitted model
summary(sarima_model)

# Check residuals of the SARIMA model
checkresiduals(sarima_model)

# Forecast the next 365 days (or another period)
sarima_forecast <- forecast(sarima_model, h = 500)

# Plot the forecast
plot(sarima_forecast, main="SARIMA Forecast for VRES Time Series")

# Visualize the SARIMA forecast with confidence intervals
autoplot(sarima_forecast) +
  ggtitle("SARIMA Forecast for VRES Time Series") +
  xlab("Date") +
  ylab("Energy Production (GWh)")
```

### Daily Data of Day-Ahead Prices of Baseload

#### 1. Visualization of Day-Ahead Prices

```{r, plot of day-ahead, echo = FALSE, warning = F}

# Create a line plot of Baseload_EUR_MWh over time
ggplot(d.d, aes(x = as.Date(Date), y = Baseload_EUR_MWh)) +
  geom_line(color = "darkblue", size = 0.5) +
  labs(title = "Baseload Energy Prices Over Time",
       x = NULL, 
       y = "Baseload (EUR/MWh)") +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y")

```

#### 2. Decomposition of Day-Ahead Prices

```{r, decomposition of day-ahead, echo = FALSE, warning = F}
# Convert the Baseload_EUR_MWh column to a time series object
# Assuming daily data, we set frequency = 365 for yearly seasonality
baseload_ts <- ts(d.d$Baseload_EUR_MWh, start = c(2017, 1), frequency = 365)

# Decompose the time series into trend, seasonal, and random components
decomp_baseload <- decompose(baseload_ts)

# Plot the decomposition
plot(decomp_baseload)

```

#### 3. Stationarity of Day-Ahead Prices

```{r, differencing of day-ahead, echo = FALSE, warning = F}
# Apply first-order differencing to remove the trend
diff_baseload_ts <- diff(baseload_ts, differences = 1)

# Plot the differenced series
plot(diff_baseload_ts, main="Differenced Baseload Time Series")

# Apply seasonal differencing (assuming yearly seasonality with a frequency of 365)
seasonal_diff_baseload_ts <- diff(diff_baseload_ts, lag = 365)

# Plot the seasonally differenced series
plot(seasonal_diff_baseload_ts, main="Seasonally Differenced Baseload Time Series")

```

```{r, differencing baseload, echo = FALSE, warning = F}
# Apply log transformation (add a small constant to avoid log(0) issues)
baseload_log_d <- log(baseload_ts + 1e-6)

# Apply first-order differencing to the log-transformed series
baseload_log_diff_d <- diff(baseload_log_d)

# Apply seasonal differencing
baseload_log_seasonal_diff_d <- diff(baseload_log_diff_d, lag = 365)
sum(is.na(baseload_log_seasonal_diff_d))

plot(baseload_log_seasonal_diff_d, 
     main="Log-Transformed and Seasonally Differenced Baseload Time Series", 
     ylab = "Differenced EUR", 
     xlab = NULL)

```

```{r, vres stationarity, echo = FALSE, warning = F}
# Perform ADF test to check stationarity
adf.test(baseload_log_seasonal_diff_d)
```

#### 4. Forecast of Day-Ahead Prices

```{r, plot of day-ahead, echo = FALSE, warning = F}
# Fit SARIMA model using auto.arima
sarima_model_baseload <- auto.arima(baseload_ts, seasonal = TRUE)

# Summary of the fitted SARIMA model
summary(sarima_model_baseload)

# Forecast the next 365 days (or another period)
sarima_forecast_baseload <- forecast(sarima_model_prices, h = 500)

# Visualize the SARIMA forecast with confidence intervals
autoplot(sarima_forecast_baseload) +
  ggtitle("SARIMA Forecast for Baseload Time Series") +
  xlab("Date") +
  ylab("Baseload (EUR)")
```

### Time Series of Electricity Price Ranges (OLD - TO BE DELETED)

Plot: Time series plot showing the average secondary electricity price ranges over time. Purpose: To visualize how the secondary price ranges fluctuate over time.

```{r, ts secondary range, echo = FALSE, warning = F}

# plot time series of electricity prices
ggplot(d, aes(x = Timestamp)) +
  geom_line(aes(y = avg_secondary_price_range, color = "Secondary Price Range")) +
  geom_smooth(aes(y = avg_secondary_price_range, color = "Linear Trend"), 
              method = "lm", 
              se = FALSE) +
  labs(title = "Time Series of Average Secondary Price Ranges",
       x = NULL,
       y = "Price Range (CHF)") +
  scale_color_manual(name = "Price Range",
                     values = c("Secondary Price Range" = "blue", 
                                "Linear Trend" = "orange"))
```

Plot: Time series plot showing the average tertiary electricity price ranges over time. Purpose: To visualize how the tertiary price ranges fluctuate over time.

```{r, ts tertiary range, echo = FALSE, warning = F}

# plot time series of electricity prices
ggplot(d, aes(x = Timestamp)) +
  geom_line(aes(y = avg_tertiary_price_range, color = "Tertiary Price Range")) +
  geom_smooth(aes(y = avg_tertiary_price_range, color = "Linear Trend"), 
              method = "lm", 
              se = TRUE) +
  labs(title = "Time Series of Average Tertiary Price Ranges",
       x = NULL,
       y = "Price Range (CHF)") +
  scale_color_manual(name = "Price Range",
                     values = c("Tertiary Price Range" = "darkgreen", 
                                "Linear Trend" = "orange"))
```

### Time Series of VRES Percent

Plot: Time series plot showing the percentage of Variable Renewable Energy Sources over time. Purpose: To analyze the penetration of VRES in the energy grid over time.

```{r, time series of vres percent, echo = FALSE, warning = F}

# Plot time series of VRES percent
ggplot(d, aes(x = Timestamp)) +
  geom_line(aes(y = VRES_percent, color = "VRES Percent")) +
  labs(title = "Time Series of Variable Renewable Energy Sources Percentage",
       x = NULL,
       y = "VRES") +
  geom_smooth(aes(y = VRES_percent, color = "Linear Trend"), 
              method = "lm", 
              se = FALSE) +
  scale_color_manual(name = "VRES", 
                     values = c("VRES Percent" = "purple", "Linear Trend" = "orange"))
```

### Time Series of Actual vs Forecasted Load

Plot: Time series plot comparing the actual and forecasted electricity load in Switzerland. Purpose: To evaluate the accuracy of load forecasting and identify discrepancies.

```{r, time series of actual vs. forecast, echo = FALSE, warning = F}

# Plot time series of actual vs. forecast
ggplot(d, aes(x = Timestamp)) +
  geom_line(aes(y = CH_load_actual_entsoe_transparency, color = "Actual Load")) +
  geom_line(aes(y = CH_load_forecast_entsoe_transparency, color = "Forecasted Load")) +
  labs(title = "Time Series of Actual vs Forecasted Electricity Load",
       x = NULL,
       y = "Load (MW)") +
  scale_color_manual(name = "Load Type", 
                     values = c("Actual Load" = "blue", "Forecasted Load" = "orange"))
```

Suggest 2-3 models, done well. This means verifying the assumptions and making neccesary transformation. I suggest doing the results in a seperate section

# Results

## Limitations

-cover general limitations

# Conclusion

What did we learn, what did we not learn, how does this relate to policymakers.

\newpage

# Biblioghraphy
